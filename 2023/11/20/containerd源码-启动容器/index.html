<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-nature.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-nature.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.naturelr.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="containerd得启动也分为服务端和客户端">
<meta property="og:type" content="article">
<meta property="og:title" content="containerd源码-启动容器">
<meta property="og:url" content="http://blog.naturelr.cc/2023/11/20/containerd%E6%BA%90%E7%A0%81-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8/index.html">
<meta property="og:site_name" content="Nature丿灵然">
<meta property="og:description" content="containerd得启动也分为服务端和客户端">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-20T03:18:00.000Z">
<meta property="article:modified_time" content="2025-06-01T14:40:41.204Z">
<meta property="article:author" content="Nature丿灵然">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="containerd">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.naturelr.cc/2023/11/20/containerd%E6%BA%90%E7%A0%81-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.naturelr.cc/2023/11/20/containerd%E6%BA%90%E7%A0%81-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8/","path":"2023/11/20/containerd源码-启动容器/","title":"containerd源码-启动容器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>containerd源码-启动容器 | Nature丿灵然</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Nature丿灵然</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">尽人事听天命</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">1.</span> <span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#container-create"><span class="nav-number">2.</span> <span class="nav-text">container create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#task-start"><span class="nav-number">3.</span> <span class="nav-text">task start</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#run%E5%91%BD%E4%BB%A4"><span class="nav-number">3.1.</span> <span class="nav-text">run命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">4.</span> <span class="nav-text">服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#container"><span class="nav-number">4.1.</span> <span class="nav-text">container</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#container-grpc"><span class="nav-number">4.1.1.</span> <span class="nav-text">container grpc</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#container-service"><span class="nav-number">4.1.2.</span> <span class="nav-text">container service</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#task"><span class="nav-number">5.</span> <span class="nav-text">task</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#task-grpc"><span class="nav-number">5.1.</span> <span class="nav-text">task grpc</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#task-serivce"><span class="nav-number">5.1.1.</span> <span class="nav-text">task serivce</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#runtime"><span class="nav-number">5.2.</span> <span class="nav-text">runtime</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Nature丿灵然</p>
  <div class="site-description" itemprop="description">Nature丿灵然的博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">100</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/NatureLR" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;NatureLR" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/1127711564@qq.com" title="E-Mail → 1127711564@qq.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.naturelr.cc/2023/11/20/containerd%E6%BA%90%E7%A0%81-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Nature丿灵然">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nature丿灵然">
      <meta itemprop="description" content="Nature丿灵然的博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="containerd源码-启动容器 | Nature丿灵然">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          containerd源码-启动容器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-20 11:18:00" itemprop="dateCreated datePublished" datetime="2023-11-20T11:18:00+08:00">2023-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-01 22:40:41" itemprop="dateModified" datetime="2025-06-01T22:40:41+08:00">2025-06-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>containerd得启动也分为服务端和客户端</p>
<span id="more"></span>

<p>代码版本为v.17.5</p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><blockquote>
<p>ctr启动一个pod有两种方式，一个是是run命令直接启动一个pod，还有一种先创建container，在创建task在启动,run命令指示把contaIner和task一块处理了</p>
</blockquote>
<h4 id="container-create"><a href="#container-create" class="headerlink" title="container create"></a>container create</h4><ul>
<li>入口这里</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// cmd/ctr/commands/containers/containers.go</span>
<span class="token keyword">var</span> createCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span>
  Name<span class="token punctuation">:</span>      <span class="token string">"create"</span><span class="token punctuation">,</span>
  Usage<span class="token punctuation">:</span>     <span class="token string">"create container"</span><span class="token punctuation">,</span>
  ArgsUsage<span class="token punctuation">:</span> <span class="token string">"[flags] Image|RootFS CONTAINER [COMMAND] [ARG...]"</span><span class="token punctuation">,</span>
  Flags<span class="token punctuation">:</span>     <span class="token function">append</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>SnapshotterFlags<span class="token punctuation">,</span> commands<span class="token punctuation">.</span>ContainerFlags<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 参数处理</span>
    client<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> err <span class="token operator">:=</span> commands<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> client<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>去除配置相关的主要是查看snapshotter中有没有解压如果没有则解压，然后将处理后的配置信息传递给<code>client.NewContainer()</code></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// cmd/ctr/commands/run/run_unix.go</span>

<span class="token keyword">func</span> <span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx gocontext<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> client <span class="token operator">*</span>containerd<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>containerd<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// ...</span>
      i<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ImageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ref<span class="token punctuation">)</span>
      <span class="token keyword">if</span> ps <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"platform"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ps <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
        platform<span class="token punctuation">,</span> err <span class="token operator">:=</span> platforms<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
        image <span class="token operator">=</span> containerd<span class="token punctuation">.</span><span class="token function">NewImageWithPlatform</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> i<span class="token punctuation">,</span> platforms<span class="token punctuation">.</span><span class="token function">Only</span><span class="token punctuation">(</span>platform<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        image <span class="token operator">=</span> containerd<span class="token punctuation">.</span><span class="token function">NewImage</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> i<span class="token punctuation">)</span>

      unpacked<span class="token punctuation">,</span> err <span class="token operator">:=</span> image<span class="token punctuation">.</span><span class="token function">IsUnpacked</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> snapshotter<span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token operator">!</span>unpacked <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> image<span class="token punctuation">.</span><span class="token function">Unpack</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> snapshotter<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

  cOpts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cOpts<span class="token punctuation">,</span> spec<span class="token punctuation">)</span>

  <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> cOpts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>随后将前面的参数传递到Container，然后调用grpc创建<code>container</code></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// client.go</span>


<span class="token comment">// NewContainer will create a new container in container with the provided id</span>
<span class="token comment">// the id must be unique within the namespace</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>NewContainerOpts<span class="token punctuation">)</span> <span class="token punctuation">(</span>Container<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ctx<span class="token punctuation">,</span> done<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">WithLease</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword">defer</span> <span class="token function">done</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

  container <span class="token operator">:=</span> containers<span class="token punctuation">.</span>Container<span class="token punctuation">&#123;</span>
    ID<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
    Runtime<span class="token punctuation">:</span> containers<span class="token punctuation">.</span>RuntimeInfo<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span> c<span class="token punctuation">.</span>runtime<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> o <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">o</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  r<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ContainerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> container<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">containerFromRecord</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="task-start"><a href="#task-start" class="headerlink" title="task start"></a>task start</h4><ul>
<li>前面创建完容器之后就需要创建一个task</li>
<li>创建完task之后就启动task，这里处理detach这个参数如果有则不会退出之后删除</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// cmd/ctr/commands/tasks/start.go</span>

<span class="token keyword">var</span> startCommand <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span>
  Name<span class="token punctuation">:</span>      <span class="token string">"start"</span><span class="token punctuation">,</span>
  Usage<span class="token punctuation">:</span>     <span class="token string">"start a container that has been created"</span><span class="token punctuation">,</span>
  ArgsUsage<span class="token punctuation">:</span> <span class="token string">"CONTAINER"</span><span class="token punctuation">,</span>
  Flags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">&#123;</span>
    cli<span class="token punctuation">.</span>BoolFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"null-io"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"send all IO to /dev/null"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cli<span class="token punctuation">.</span>StringFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"log-uri"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"log uri"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cli<span class="token punctuation">.</span>StringFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"fifo-dir"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"directory used for storing IO FIFOs"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cli<span class="token punctuation">.</span>StringFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"pid-file"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"file path to write the task's pid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cli<span class="token punctuation">.</span>BoolFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"detach,d"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"detach from the task after it has started execution"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    client<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> err <span class="token operator">:=</span> commands<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    container<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">LoadContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

    spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">Spec</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">var</span> con console<span class="token punctuation">.</span>Console
    <span class="token keyword">if</span> tty <span class="token punctuation">&#123;</span>
      con <span class="token operator">=</span> console<span class="token punctuation">.</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">defer</span> con<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> con<span class="token punctuation">.</span><span class="token function">SetRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    task<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> client<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> con<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"null-io"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"log-uri"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ioOpts<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> statusC <span class="token operator">&lt;-</span><span class="token keyword">chan</span> containerd<span class="token punctuation">.</span>ExitStatus
    <span class="token keyword">if</span> <span class="token operator">!</span>detach <span class="token punctuation">&#123;</span>
      <span class="token keyword">defer</span> task<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      <span class="token keyword">if</span> statusC<span class="token punctuation">,</span> err <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> context<span class="token punctuation">.</span><span class="token function">IsSet</span><span class="token punctuation">(</span><span class="token string">"pid-file"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> commands<span class="token punctuation">.</span><span class="token function">WritePidFile</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"pid-file"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">Pid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> detach <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span>

    status <span class="token operator">:=</span> <span class="token operator">&lt;-</span>statusC
    code<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> task<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> code <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> cli<span class="token punctuation">.</span><span class="token function">NewExitError</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>NewTask处理了下命令行相关，然后调用了container.NewTask()</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// cmd/ctr/commands/tasks/tasks_unix.go</span>

<span class="token keyword">func</span> <span class="token function">NewTask</span><span class="token punctuation">(</span>ctx gocontext<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> client <span class="token operator">*</span>containerd<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> container containerd<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> checkpoint <span class="token builtin">string</span><span class="token punctuation">,</span> con console<span class="token punctuation">.</span>Console<span class="token punctuation">,</span> nullIO <span class="token builtin">bool</span><span class="token punctuation">,</span> logURI <span class="token builtin">string</span><span class="token punctuation">,</span> ioOpts <span class="token punctuation">[</span><span class="token punctuation">]</span>cio<span class="token punctuation">.</span>Opt<span class="token punctuation">,</span> opts <span class="token operator">...</span>containerd<span class="token punctuation">.</span>NewTaskOpts<span class="token punctuation">)</span> <span class="token punctuation">(</span>containerd<span class="token punctuation">.</span>Task<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  stdinC <span class="token operator">:=</span> <span class="token operator">&amp;</span>stdinCloser<span class="token punctuation">&#123;</span>
    stdin<span class="token punctuation">:</span> os<span class="token punctuation">.</span>Stdin<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> checkpoint <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
    im<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">GetImage</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> checkpoint<span class="token punctuation">)</span>

    opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> containerd<span class="token punctuation">.</span><span class="token function">WithTaskCheckpoint</span><span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">var</span> ioCreator cio<span class="token punctuation">.</span>Creator
  <span class="token keyword">if</span> con <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> nullIO <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"tty and null-io cannot be used together"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    ioCreator <span class="token operator">=</span> cio<span class="token punctuation">.</span><span class="token function">NewCreator</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>cio<span class="token punctuation">.</span>Opt<span class="token punctuation">&#123;</span>cio<span class="token punctuation">.</span><span class="token function">WithStreams</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> con<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cio<span class="token punctuation">.</span>WithTerminal<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> ioOpts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> nullIO <span class="token punctuation">&#123;</span>
    ioCreator <span class="token operator">=</span> cio<span class="token punctuation">.</span>NullIO
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> logURI <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
    u<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>logURI<span class="token punctuation">)</span>
    ioCreator <span class="token operator">=</span> cio<span class="token punctuation">.</span><span class="token function">LogURI</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    ioCreator <span class="token operator">=</span> cio<span class="token punctuation">.</span><span class="token function">NewCreator</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>cio<span class="token punctuation">.</span>Opt<span class="token punctuation">&#123;</span>cio<span class="token punctuation">.</span><span class="token function">WithStreams</span><span class="token punctuation">(</span>stdinC<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> ioOpts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  t<span class="token punctuation">,</span> err <span class="token operator">:=</span> container<span class="token punctuation">.</span><span class="token function">NewTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ioCreator<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>

  stdinC<span class="token punctuation">.</span>closer <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    t<span class="token punctuation">.</span><span class="token function">CloseIO</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> containerd<span class="token punctuation">.</span>WithStdinCloser<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> t<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="run命令"><a href="#run命令" class="headerlink" title="run命令"></a>run命令</h5><ul>
<li>基本就是将<code>container create</code>和<code>task start</code>的逻辑组合到一块</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Command runs a container</span>
<span class="token keyword">var</span> Command <span class="token operator">=</span> cli<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span>
  Name<span class="token punctuation">:</span>           <span class="token string">"run"</span><span class="token punctuation">,</span>
  Usage<span class="token punctuation">:</span>          <span class="token string">"run a container"</span><span class="token punctuation">,</span>
  ArgsUsage<span class="token punctuation">:</span>      <span class="token string">"[flags] Image|RootFS ID [COMMAND] [ARG...]"</span><span class="token punctuation">,</span>
  SkipArgReorder<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  Flags<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">&#123;</span>
    cli<span class="token punctuation">.</span>BoolFlag<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>  <span class="token string">"detach,d"</span><span class="token punctuation">,</span>
      Usage<span class="token punctuation">:</span> <span class="token string">"detach from the task after it has started execution"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>platformRunFlags<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>SnapshotterFlags<span class="token punctuation">,</span> commands<span class="token punctuation">.</span>ContainerFlags<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Action<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>

    client<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> err <span class="token operator">:=</span> commands<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    container<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> client<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  
    <span class="token keyword">if</span> context<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"rm"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>detach <span class="token punctuation">&#123;</span>
      <span class="token keyword">defer</span> container<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> containerd<span class="token punctuation">.</span>WithSnapshotCleanup<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">var</span> con console<span class="token punctuation">.</span>Console
    <span class="token keyword">if</span> tty <span class="token punctuation">&#123;</span>
      con <span class="token operator">=</span> console<span class="token punctuation">.</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">defer</span> con<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> con<span class="token punctuation">.</span><span class="token function">SetRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">var</span> network gocni<span class="token punctuation">.</span>CNI
    <span class="token keyword">if</span> enableCNI <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> network<span class="token punctuation">,</span> err <span class="token operator">=</span> gocni<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>gocni<span class="token punctuation">.</span>WithDefaultConf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    opts <span class="token operator">:=</span> <span class="token function">getNewTaskOpts</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    ioOpts <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>cio<span class="token punctuation">.</span>Opt<span class="token punctuation">&#123;</span>cio<span class="token punctuation">.</span><span class="token function">WithFIFODir</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"fifo-dir"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    task<span class="token punctuation">,</span> err <span class="token operator">:=</span> tasks<span class="token punctuation">.</span><span class="token function">NewTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> client<span class="token punctuation">,</span> container<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"checkpoint"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> con<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"null-io"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"log-uri"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ioOpts<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
 

    <span class="token keyword">var</span> statusC <span class="token operator">&lt;-</span><span class="token keyword">chan</span> containerd<span class="token punctuation">.</span>ExitStatus
    <span class="token keyword">if</span> <span class="token operator">!</span>detach <span class="token punctuation">&#123;</span>
      <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> enableCNI <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> err <span class="token operator">:=</span> network<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">fullID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"network review"</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        task<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> statusC<span class="token punctuation">,</span> err <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> err
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> tty <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> tasks<span class="token punctuation">.</span><span class="token function">HandleConsoleResize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> task<span class="token punctuation">,</span> con<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        logrus<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"console resize"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      sigc <span class="token operator">:=</span> commands<span class="token punctuation">.</span><span class="token function">ForwardAllSignals</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> task<span class="token punctuation">)</span>
      <span class="token keyword">defer</span> commands<span class="token punctuation">.</span><span class="token function">StopCatch</span><span class="token punctuation">(</span>sigc<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    status <span class="token operator">:=</span> <span class="token operator">&lt;-</span>statusC
    code<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> task<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> code <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> cli<span class="token punctuation">.</span><span class="token function">NewExitError</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><h5 id="container"><a href="#container" class="headerlink" title="container"></a>container</h5><h6 id="container-grpc"><a href="#container-grpc" class="headerlink" title="container grpc"></a>container grpc</h6><ul>
<li>插件注册，依赖一个service</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/containers/service.go</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plugin<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span>
    Type<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span>GRPCPlugin<span class="token punctuation">,</span>
    ID<span class="token punctuation">:</span>   <span class="token string">"containers"</span><span class="token punctuation">,</span>
    Requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Type<span class="token punctuation">&#123;</span>
      plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    InitFn<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ic <span class="token operator">*</span>plugin<span class="token punctuation">.</span>InitContext<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      plugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">GetByType</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">&#125;</span>
      p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> plugins<span class="token punctuation">[</span>services<span class="token punctuation">.</span>ContainersService<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"containers service not found"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      i<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token operator">&amp;</span>service<span class="token punctuation">&#123;</span>local<span class="token punctuation">:</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>ContainersClient<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>api则直接调用了上层</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>api<span class="token punctuation">.</span>CreateContainerRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>CreateContainerResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h6 id="container-service"><a href="#container-service" class="headerlink" title="container service"></a>container service</h6><ul>
<li>插件注册</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/containers/local.go</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plugin<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span>
    Type<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">,</span>
    ID<span class="token punctuation">:</span>   services<span class="token punctuation">.</span>ContainersService<span class="token punctuation">,</span>
    Requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Type<span class="token punctuation">&#123;</span>
      plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    InitFn<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ic <span class="token operator">*</span>plugin<span class="token punctuation">.</span>InitContext<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      m<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">)</span>

      db <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>metadata<span class="token punctuation">.</span>DB<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">&amp;</span>local<span class="token punctuation">&#123;</span>
        Store<span class="token punctuation">:</span>     metadata<span class="token punctuation">.</span><span class="token function">NewContainerStore</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span>        db<span class="token punctuation">,</span>
        publisher<span class="token punctuation">:</span> ic<span class="token punctuation">.</span>Events<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>主要调用了<code>Store.Create()</code>数据库中创建一个<code>container</code>,且上传了事件</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/containers/local.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>local<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>api<span class="token punctuation">.</span>CreateContainerRequest<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>CreateContainerResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> resp api<span class="token punctuation">.</span>CreateContainerResponse
  <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">withStoreUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    container <span class="token operator">:=</span> <span class="token function">containerFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Container<span class="token punctuation">)</span>
    created<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>Store<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>Container <span class="token operator">=</span> <span class="token function">containerToProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>created<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/containers/create"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>eventstypes<span class="token punctuation">.</span>ContainerCreate<span class="token punctuation">&#123;</span>
    ID<span class="token punctuation">:</span>    resp<span class="token punctuation">.</span>Container<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
    Image<span class="token punctuation">:</span> resp<span class="token punctuation">.</span>Container<span class="token punctuation">.</span>Image<span class="token punctuation">,</span>
    Runtime<span class="token punctuation">:</span> <span class="token operator">&amp;</span>eventstypes<span class="token punctuation">.</span>ContainerCreate_Runtime<span class="token punctuation">&#123;</span>
      Name<span class="token punctuation">:</span>    resp<span class="token punctuation">.</span>Container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
      Options<span class="token punctuation">:</span> resp<span class="token punctuation">.</span>Container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Options<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">,</span> err
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>看下数据中对于Container的实现</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// metadata/containers.go</span>

<span class="token comment">// NewContainerStore returns a Store backed by an underlying bolt DB</span>
<span class="token keyword">func</span> <span class="token function">NewContainerStore</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> containers<span class="token punctuation">.</span>Store <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>containerStore<span class="token punctuation">&#123;</span>
    db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>首先校验了了一下container,然后在数据库中创建一个记录</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// metadata/containers.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>containerStore<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> container containers<span class="token punctuation">.</span>Container<span class="token punctuation">)</span> <span class="token punctuation">(</span>containers<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  namespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> namespaces<span class="token punctuation">.</span><span class="token function">NamespaceRequired</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">validateContainer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> containers<span class="token punctuation">.</span>Container<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"create container failed validation"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>db<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>bolt<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    bkt<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createContainersBucket</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
    cbkt<span class="token punctuation">,</span> err <span class="token operator">:=</span> bkt<span class="token punctuation">.</span><span class="token function">CreateBucket</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> err <span class="token operator">==</span> bolt<span class="token punctuation">.</span>ErrBucketExists <span class="token punctuation">&#123;</span>
        err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>errdefs<span class="token punctuation">.</span>ErrAlreadyExists<span class="token punctuation">,</span> <span class="token string">"container %q"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    container<span class="token punctuation">.</span>CreatedAt <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    container<span class="token punctuation">.</span>UpdatedAt <span class="token operator">=</span> container<span class="token punctuation">.</span>CreatedAt
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">writeContainer</span><span class="token punctuation">(</span>cbkt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to write container %q"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> containers<span class="token punctuation">.</span>Container<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> container<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="task"><a href="#task" class="headerlink" title="task"></a>task</h4><h5 id="task-grpc"><a href="#task-grpc" class="headerlink" title="task grpc"></a>task grpc</h5><ul>
<li>注册依赖于service的插件</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/tasks/service.go</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plugin<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span>
    Type<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span>GRPCPlugin<span class="token punctuation">,</span>
    ID<span class="token punctuation">:</span>   <span class="token string">"tasks"</span><span class="token punctuation">,</span>
    Requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Type<span class="token punctuation">&#123;</span>
      plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    InitFn<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ic <span class="token operator">*</span>plugin<span class="token punctuation">.</span>InitContext<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      plugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">GetByType</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">)</span>
      p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> plugins<span class="token punctuation">[</span>services<span class="token punctuation">.</span>TasksService<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"tasks service not found"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      i<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">&amp;</span>service<span class="token punctuation">&#123;</span>local<span class="token punctuation">:</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>TasksClient<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>api直接调用上层的插件了</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> r <span class="token operator">*</span>api<span class="token punctuation">.</span>CreateTaskRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>CreateTaskResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> r <span class="token operator">*</span>api<span class="token punctuation">.</span>StartRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>StartResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="task-serivce"><a href="#task-serivce" class="headerlink" title="task serivce"></a>task serivce</h6><ul>
<li>初始化的过程根据平台来选,分别有bsd，unix和win主要看unix</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plugin<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span>
    Type<span class="token punctuation">:</span>     plugin<span class="token punctuation">.</span>ServicePlugin<span class="token punctuation">,</span>
    ID<span class="token punctuation">:</span>       services<span class="token punctuation">.</span>TasksService<span class="token punctuation">,</span>
    Requires<span class="token punctuation">:</span> tasksServiceRequires<span class="token punctuation">,</span>
    InitFn<span class="token punctuation">:</span>   initFunc<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  timeout<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>stateTimeout<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>unix加载的插件</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/tasks/local_unix.go</span>
<span class="token keyword">var</span> tasksServiceRequires <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Type<span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span>RuntimePlugin<span class="token punctuation">,</span>
  plugin<span class="token punctuation">.</span>RuntimePluginV2<span class="token punctuation">,</span>
  plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">,</span>
  plugin<span class="token punctuation">.</span>TaskMonitorPlugin<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>根据平台调用<code>loadV1Runtimes()</code>加载runtimev1然后遍历</li>
<li>runtimev2 则是通过<code>ic.Get(plugin.RuntimePluginV2)</code>通过插件的形式拿到</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/tasks/local.go</span>

<span class="token keyword">func</span> <span class="token function">initFunc</span><span class="token punctuation">(</span>ic <span class="token operator">*</span>plugin<span class="token punctuation">.</span>InitContext<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  runtimes<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadV1Runtimes</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span>

  v2r<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>RuntimePluginV2<span class="token punctuation">)</span>

  m<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">)</span>

  monitor<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>TaskMonitorPlugin<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>errdefs<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">&#125;</span>
    monitor <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewNoopMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  db <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>metadata<span class="token punctuation">.</span>DB<span class="token punctuation">)</span>
  l <span class="token operator">:=</span> <span class="token operator">&amp;</span>local<span class="token punctuation">&#123;</span>
    runtimes<span class="token punctuation">:</span>   runtimes<span class="token punctuation">,</span>
    containers<span class="token punctuation">:</span> metadata<span class="token punctuation">.</span><span class="token function">NewContainerStore</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    store<span class="token punctuation">:</span>      db<span class="token punctuation">.</span><span class="token function">ContentStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publisher<span class="token punctuation">:</span>  ic<span class="token punctuation">.</span>Events<span class="token punctuation">,</span>
    monitor<span class="token punctuation">:</span>    monitor<span class="token punctuation">.</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>TaskMonitor<span class="token punctuation">)</span><span class="token punctuation">,</span>
    v2Runtime<span class="token punctuation">:</span>  v2r<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v2<span class="token punctuation">.</span>TaskManager<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> runtimes <span class="token punctuation">&#123;</span>
    tasks<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Tasks</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> tasks <span class="token punctuation">&#123;</span>
      l<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  v2Tasks<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>v2Runtime<span class="token punctuation">.</span><span class="token function">Tasks</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> v2Tasks <span class="token punctuation">&#123;</span>
    l<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> l<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>具体api实现方面，通过请求的容器id获取容器，处理下需要恢复路径，因为contaInerd重启容器并不会退出，所以需要contaIner找到之前的容器</li>
<li>处理rootfs</li>
<li>获取一个<code>runtime.get()</code> 获取一个task没然后执行创建task</li>
<li>随后调用<code>monitor.Monitor(c)</code>监控容器</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/tasks/local.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>local<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> r <span class="token operator">*</span>api<span class="token punctuation">.</span>CreateTaskRequest<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>CreateTaskResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  container<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">getContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">)</span>
  checkpointPath<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getRestorePath</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Options<span class="token punctuation">)</span>

  <span class="token keyword">if</span> checkpointPath <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>Checkpoint <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    checkpointPath<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">TempDir</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"XDG_RUNTIME_DIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ctrd-checkpoint"</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>MediaType <span class="token operator">!=</span> images<span class="token punctuation">.</span>MediaTypeContainerd1Checkpoint <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unsupported checkpoint type %q"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>MediaType<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    reader<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">ReaderAt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ocispec<span class="token punctuation">.</span>Descriptor<span class="token punctuation">&#123;</span>
      MediaType<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>MediaType<span class="token punctuation">,</span>
      Digest<span class="token punctuation">:</span>      r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>Digest<span class="token punctuation">,</span>
      Size<span class="token punctuation">:</span>        r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>Size_<span class="token punctuation">,</span>
      Annotations<span class="token punctuation">:</span> r<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">.</span>Annotations<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> archive<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> checkpointPath<span class="token punctuation">,</span> content<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">)</span>
    reader<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">&#125;</span>
  opts <span class="token operator">:=</span> runtime<span class="token punctuation">.</span>CreateOpts<span class="token punctuation">&#123;</span>
    Spec<span class="token punctuation">:</span> container<span class="token punctuation">.</span>Spec<span class="token punctuation">,</span>
    IO<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>IO<span class="token punctuation">&#123;</span>
      Stdin<span class="token punctuation">:</span>    r<span class="token punctuation">.</span>Stdin<span class="token punctuation">,</span>
      Stdout<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span>
      Stderr<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span>
      Terminal<span class="token punctuation">:</span> r<span class="token punctuation">.</span>Terminal<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    Checkpoint<span class="token punctuation">:</span>     checkpointPath<span class="token punctuation">,</span>
    Runtime<span class="token punctuation">:</span>        container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
    RuntimeOptions<span class="token punctuation">:</span> container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Options<span class="token punctuation">,</span>
    TaskOptions<span class="token punctuation">:</span>    r<span class="token punctuation">.</span>Options<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>Rootfs <span class="token punctuation">&#123;</span>
    opts<span class="token punctuation">.</span>Rootfs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>Rootfs<span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Mount<span class="token punctuation">&#123;</span>
      Type<span class="token punctuation">:</span>    m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
      Source<span class="token punctuation">:</span>  m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span>
      Options<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Options<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"io.containerd.runtime.v1."</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">G</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"runtime v1 is deprecated since containerd v1.4, consider using runtime v2"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name <span class="token operator">==</span> plugin<span class="token punctuation">.</span>RuntimeRuncV1 <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">G</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">"%q is deprecated since containerd v1.4, consider using %q"</span><span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>RuntimeRuncV1<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>RuntimeRuncV2<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  rtime<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> rtime<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> runtime<span class="token punctuation">.</span>ErrTaskNotExists <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"task %s already exists"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  c<span class="token punctuation">,</span> err <span class="token operator">:=</span> rtime<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"monitor task"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>CreateTaskResponse<span class="token punctuation">&#123;</span>
    ContainerID<span class="token punctuation">:</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">,</span>
    Pid<span class="token punctuation">:</span>         c<span class="token punctuation">.</span><span class="token function">PID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>start根据上一步创建的task获取进程然后启动进程</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// services/tasks/local.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>local<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> r <span class="token operator">*</span>api<span class="token punctuation">.</span>StartRequest<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>StartResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  t<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">)</span>

  p <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
  <span class="token keyword">if</span> r<span class="token punctuation">.</span>ExecID <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> p<span class="token punctuation">,</span> err <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ExecID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  state<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">State</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">ToGRPC</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>StartResponse<span class="token punctuation">&#123;</span>
    Pid<span class="token punctuation">:</span> state<span class="token punctuation">.</span>Pid<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h5><ul>
<li>runtime有2个版本现在普遍使用v2,他的初始化会根据平台传递一个config，最后拿到的参数传递给<code>New()</code></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// runtime/v2/manager.go</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>plugin<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span>
    Type<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span>RuntimePluginV2<span class="token punctuation">,</span>
    ID<span class="token punctuation">:</span>   <span class="token string">"task"</span><span class="token punctuation">,</span>
    Requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Type<span class="token punctuation">&#123;</span>
      plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    Config<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">&#123;</span>
      Platforms<span class="token punctuation">:</span> <span class="token function">defaultPlatforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    InitFn<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ic <span class="token operator">*</span>plugin<span class="token punctuation">.</span>InitContext<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      supportedPlatforms<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">parsePlatforms</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Config<span class="token punctuation">)</span><span class="token punctuation">.</span>Platforms<span class="token punctuation">)</span>

      ic<span class="token punctuation">.</span>Meta<span class="token punctuation">.</span>Platforms <span class="token operator">=</span> supportedPlatforms
      <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> <span class="token number">0711</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>State<span class="token punctuation">,</span> <span class="token number">0711</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
      <span class="token punctuation">&#125;</span>
      m<span class="token punctuation">,</span> err <span class="token operator">:=</span> ic<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>MetadataPlugin<span class="token punctuation">)</span>

      cs <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewContainerStore</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>metadata<span class="token punctuation">.</span>DB<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> <span class="token function">New</span><span class="token punctuation">(</span>ic<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ic<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> ic<span class="token punctuation">.</span>State<span class="token punctuation">,</span> ic<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> ic<span class="token punctuation">.</span>TTRPCAddress<span class="token punctuation">,</span> ic<span class="token punctuation">.</span>Events<span class="token punctuation">,</span> cs<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>New()创建了文件夹和初始化了一个<code>TaskManager</code>,然后调用loadExistingTasks()方法加载已经存在的task</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// New task manager for v2 shims</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> root<span class="token punctuation">,</span> state<span class="token punctuation">,</span> containerdAddress<span class="token punctuation">,</span> containerdTTRPCAddress <span class="token builtin">string</span><span class="token punctuation">,</span> events <span class="token operator">*</span>exchange<span class="token punctuation">.</span>Exchange<span class="token punctuation">,</span> cs containers<span class="token punctuation">.</span>Store<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TaskManager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>root<span class="token punctuation">,</span> state<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0711</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  m <span class="token operator">:=</span> <span class="token operator">&amp;</span>TaskManager<span class="token punctuation">&#123;</span>
    root<span class="token punctuation">:</span>                   root<span class="token punctuation">,</span>
    state<span class="token punctuation">:</span>                  state<span class="token punctuation">,</span>
    containerdAddress<span class="token punctuation">:</span>      containerdAddress<span class="token punctuation">,</span>
    containerdTTRPCAddress<span class="token punctuation">:</span> containerdTTRPCAddress<span class="token punctuation">,</span>
    tasks<span class="token punctuation">:</span>                  runtime<span class="token punctuation">.</span><span class="token function">NewTaskList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    events<span class="token punctuation">:</span>                 events<span class="token punctuation">,</span>
    containers<span class="token punctuation">:</span>             cs<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadExistingTasks</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>最终通过shim创建容器，然后添加task</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Create a new task</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>TaskManager<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> opts runtime<span class="token punctuation">.</span>CreateOpts<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token boolean">_</span> runtime<span class="token punctuation">.</span>Task<span class="token punctuation">,</span> retErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  bundle<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewBundle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> m<span class="token punctuation">.</span>root<span class="token punctuation">,</span> m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> id<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> retErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      bundle<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  shim<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">startShim</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> id<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>

  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> retErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      m<span class="token punctuation">.</span><span class="token function">deleteShim</span><span class="token punctuation">(</span>shim<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  t<span class="token punctuation">,</span> err <span class="token operator">:=</span> shim<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to add task"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> t<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>看了startShim实现。通过bundel等参数构造出一个<code>binary</code>,然后调用<code>start()</code>方法</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// runtime/v2/manager.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>TaskManager<span class="token punctuation">)</span> <span class="token function">startShim</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> bundle <span class="token operator">*</span>Bundle<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> opts runtime<span class="token punctuation">.</span>CreateOpts<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>shim<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ns<span class="token punctuation">,</span> err <span class="token operator">:=</span> namespaces<span class="token punctuation">.</span><span class="token function">NamespaceRequired</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

  topts <span class="token operator">:=</span> opts<span class="token punctuation">.</span>TaskOptions

  b <span class="token operator">:=</span> <span class="token function">shimBinary</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Runtime<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdTTRPCAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>events<span class="token punctuation">,</span> m<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span>
  shim<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> topts<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">G</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithField</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"shim disconnected"</span><span class="token punctuation">)</span>

    <span class="token function">cleanupAfterDeadShim</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> m<span class="token punctuation">.</span>tasks<span class="token punctuation">,</span> m<span class="token punctuation">.</span>events<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token comment">// Remove self from the runtime task list. Even though the cleanupAfterDeadShim()</span>
    <span class="token comment">// would publish taskExit event, but the shim.Delete() would always failed with ttrpc</span>
    <span class="token comment">// disconnect and there is no chance to remove this dead task from runtime task lists.</span>
    <span class="token comment">// Thus it's better to delete it here.</span>
    m<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> shim<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>这里通过<code>client.Command()</code>组装出命令然后启动程序</li>
<li>随后创建一个ttrpc客户端返回</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>binary<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts <span class="token operator">*</span>types<span class="token punctuation">.</span>Any<span class="token punctuation">,</span> onClose <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token operator">*</span>shim<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  args <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"-id"</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>bundle<span class="token punctuation">.</span>ID<span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> logrus<span class="token punctuation">.</span><span class="token function">GetLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> logrus<span class="token punctuation">.</span>DebugLevel <span class="token punctuation">&#123;</span>
    args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">"-debug"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">"start"</span><span class="token punctuation">)</span>

  cmd<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">,</span>
    b<span class="token punctuation">.</span>runtime<span class="token punctuation">,</span>
    b<span class="token punctuation">.</span>containerdAddress<span class="token punctuation">,</span>
    b<span class="token punctuation">.</span>containerdTTRPCAddress<span class="token punctuation">,</span>
    b<span class="token punctuation">.</span>bundle<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
    opts<span class="token punctuation">,</span>
    args<span class="token operator">...</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// Windows needs a namespace when openShimLog</span>
  ns<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> namespaces<span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  shimCtx<span class="token punctuation">,</span> cancelShimLog <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">.</span><span class="token function">WithNamespace</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      <span class="token function">cancelShimLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  f<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">openShimLog</span><span class="token punctuation">(</span>shimCtx<span class="token punctuation">,</span> b<span class="token punctuation">.</span>bundle<span class="token punctuation">,</span> client<span class="token punctuation">.</span>AnonDialer<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"open shim log pipe"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// open the log pipe and block until the writer is ready</span>
  <span class="token comment">// this helps with synchronization of the shim</span>
  <span class="token comment">// copy the shim's logs to containerd's output</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token comment">// To prevent flood of error messages, the expected error</span>
    <span class="token comment">// should be reset, like os.ErrClosed or os.ErrNotExist, which</span>
    <span class="token comment">// depends on platform.</span>
    err <span class="token operator">=</span> <span class="token function">checkCopyShimLogError</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      log<span class="token punctuation">.</span><span class="token function">G</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"copy shim log"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  out<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  address <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span>
  conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> client<span class="token punctuation">.</span>AnonDialer<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">&#125;</span>
  onCloseWithShimLog <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">cancelShimLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  client <span class="token operator">:=</span> ttrpc<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> ttrpc<span class="token punctuation">.</span><span class="token function">WithOnClose</span><span class="token punctuation">(</span>onCloseWithShimLog<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>shim<span class="token punctuation">&#123;</span>
    bundle<span class="token punctuation">:</span>  b<span class="token punctuation">.</span>bundle<span class="token punctuation">,</span>
    client<span class="token punctuation">:</span>  client<span class="token punctuation">,</span>
    task<span class="token punctuation">:</span>    task<span class="token punctuation">.</span><span class="token function">NewTaskClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span>
    events<span class="token punctuation">:</span>  b<span class="token punctuation">.</span>events<span class="token punctuation">,</span>
    rtTasks<span class="token punctuation">:</span> b<span class="token punctuation">.</span>rtTasks<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><pre><code class="mermaid">sequenceDiagram
    autonumber
    participant client as 客户端
    participant container as container-service
    participant task as task-service
    #participant content as content-service
    #participant snapshotter as snapshotter-service
    participant image as image-service
    
    client-&gt;&gt;image:获取image信息
    client-&gt;&gt;container:创建容器
    client-&gt;&gt;task:创建task
    client-&gt;&gt;task:启动task</code></pre>

<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="http://blog.naturelr.cc/">http://blog.naturelr.cc</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/containerd/" rel="tag"># containerd</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/11/09/%E5%9C%A8k8s%E9%9B%86%E7%BE%A4%E4%B8%AD%E9%83%A8%E7%BD%B2tidb/" rel="prev" title="在k8s集群中部署tidb">
                  <i class="fa fa-angle-left"></i> 在k8s集群中部署tidb
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/11/23/gitlab%E9%83%A8%E7%BD%B2%E7%BB%B4%E6%8A%A4/" rel="next" title="gitlab部署配置">
                  gitlab部署配置 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Nature丿灵然</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body>
</html>
