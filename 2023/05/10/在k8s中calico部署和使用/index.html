<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-nature.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-nature.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.naturelr.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="calico是k8s中常见的网络插件,非常灵活,支持ipip,vxlan隧道bgp路由以及ebpf,虚机k8s均可使用">
<meta property="og:type" content="article">
<meta property="og:title" content="在k8s中calico部署和使用">
<meta property="og:url" content="http://blog.naturelr.cc/2023/05/10/%E5%9C%A8k8s%E4%B8%ADcalico%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Nature丿灵然">
<meta property="og:description" content="calico是k8s中常见的网络插件,非常灵活,支持ipip,vxlan隧道bgp路由以及ebpf,虚机k8s均可使用">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico.svg">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-ipip-1.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-vxlan-1.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-bgp-1.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-bgp-2.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-bgp-4.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-bgp-5.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-ipip-2.png">
<meta property="og:image" content="http://blog.naturelr.cc/images/calico-vxlan-2.png">
<meta property="article:published_time" content="2023-05-10T08:41:00.000Z">
<meta property="article:modified_time" content="2024-03-06T06:07:54.441Z">
<meta property="article:author" content="Nature丿灵然">
<meta property="article:tag" content="cni">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.naturelr.cc/images/calico.svg">


<link rel="canonical" href="http://blog.naturelr.cc/2023/05/10/%E5%9C%A8k8s%E4%B8%ADcalico%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.naturelr.cc/2023/05/10/%E5%9C%A8k8s%E4%B8%ADcalico%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8/","path":"2023/05/10/在k8s中calico部署和使用/","title":"在k8s中calico部署和使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>在k8s中calico部署和使用 | Nature丿灵然</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Nature丿灵然</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">尽人事听天命</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%AF%E8%AF%AD"><span class="nav-number">1.1.</span> <span class="nav-text">术语</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ippool"><span class="nav-number">1.1.1.</span> <span class="nav-text">ippool</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ipamblocks"><span class="nav-number">1.1.2.</span> <span class="nav-text">ipamblocks</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2calico-cni"><span class="nav-number">2.</span> <span class="nav-text">部署calico cni</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85calicoctl"><span class="nav-number">3.</span> <span class="nav-text">安装calicoctl</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8Ccalicoctl"><span class="nav-number">3.1.</span> <span class="nav-text">用容器的方式运行calicoctl</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">二进制文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kubectl%E6%8F%92%E4%BB%B6"><span class="nav-number">3.3.</span> <span class="nav-text">kubectl插件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#calicoctl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.</span> <span class="nav-text">calicoctl常用命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPIP%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.</span> <span class="nav-text">IPIP模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ipip%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90"><span class="nav-number">4.1.</span> <span class="nav-text">ipip路径分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ipip-pod%E5%88%B0pod%E6%89%80%E5%9C%A8%E7%9A%84node"><span class="nav-number">4.1.1.</span> <span class="nav-text">ipip-pod到pod所在的node</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ipip-pod%E6%89%80%E5%9C%A8%E7%9A%84node%E5%88%B0%E7%9B%AE%E6%A0%87%E6%89%80%E5%9C%A8%E7%9A%84node%E7%9A%84pod"><span class="nav-number">4.1.2.</span> <span class="nav-text">ipip-pod所在的node到目标所在的node的pod</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2%E4%B8%AApod%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AAnode%E4%B8%8A"><span class="nav-number">4.1.3.</span> <span class="nav-text">2个pod在同一个node上</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">4.1.4.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VXLAN%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">VXLAN模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%90%AFvxlan%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.</span> <span class="nav-text">开启vxlan模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vxlan%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90"><span class="nav-number">5.2.</span> <span class="nav-text">vxlan路径分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#vxlan-pod%E5%88%B0node"><span class="nav-number">5.2.1.</span> <span class="nav-text">vxlan-pod到node</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#vxlan-pod%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AAnode%E7%9A%84pod"><span class="nav-number">5.2.2.</span> <span class="nav-text">vxlan-pod到另一个node的pod</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vxlan-%E5%B0%8F%E7%BB%93"><span class="nav-number">5.3.</span> <span class="nav-text">vxlan-小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BGP%E6%A8%A1%E5%BC%8F-full-mesh"><span class="nav-number">6.</span> <span class="nav-text">BGP模式(full mesh)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%90%AFBGP%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">开启BGP模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BGP%E6%A8%A1%E5%BC%8F%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">BGP模式路径分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bgp%E5%B0%8F%E7%BB%93"><span class="nav-number">6.3.</span> <span class="nav-text">bgp小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BGP-RR%E6%A8%A1%E5%BC%8F-Route-reflectors"><span class="nav-number">7.</span> <span class="nav-text">BGP-RR模式(Route reflectors)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-number">7.1.</span> <span class="nav-text">路由反射部署方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A1%AE%E8%AE%A4%E7%8E%B0%E5%9C%A8%E7%9A%84%E4%B8%BAbgp%E7%9A%84mesh%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">确认现在的为bgp的mesh模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%8A%82%E7%82%B9%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%B0%84%E5%99%A8"><span class="nav-number">7.3.</span> <span class="nav-text">指定节点作为反射器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEbgp%E5%AF%B9%E7%AD%89%E4%BD%93"><span class="nav-number">7.4.</span> <span class="nav-text">配置bgp对等体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9bgp%E7%8A%B6%E6%80%81"><span class="nav-number">7.5.</span> <span class="nav-text">查看节点bgp状态</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BGP-TOR%E8%B7%AF%E7%94%B1"><span class="nav-number">8.</span> <span class="nav-text">BGP-TOR路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPIP-VXLAN%E8%B7%A8%E5%AD%90%E7%BD%91%E6%A8%A1%E5%BC%8F"><span class="nav-number">9.</span> <span class="nav-text">IPIP&#x2F;VXLAN跨子网模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">9.1.</span> <span class="nav-text">环境说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IPIP"><span class="nav-number">9.2.</span> <span class="nav-text">IPIP</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#VXLAN"><span class="nav-number">9.3.</span> <span class="nav-text">VXLAN</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%A8%E5%AD%90%E7%BD%91bgp-full-mesh%E6%A8%A1%E5%BC%8F%E4%B8%8B%E8%B7%AF%E7%94%B1"><span class="nav-number">9.4.</span> <span class="nav-text">跨子网bgp full mesh模式下路由</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%86ipip%E5%92%8Cvxlan%E5%85%A8%E9%83%A8%E8%AE%BE%E7%BD%AE%E4%B8%BACrossSubnet"><span class="nav-number">9.5.</span> <span class="nav-text">将ipip和vxlan全部设置为CrossSubnet</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EBPF"><span class="nav-number">10.</span> <span class="nav-text">EBPF</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#EBPF%E9%83%A8%E7%BD%B2"><span class="nav-number">10.1.</span> <span class="nav-text">EBPF部署</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%AA%8C%E8%AF%81"><span class="nav-number">10.1.1.</span> <span class="nav-text">环境验证</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9api-server%E5%9C%B0%E5%9D%80"><span class="nav-number">10.1.2.</span> <span class="nav-text">修改api-server地址</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%80%E5%90%AFebpf"><span class="nav-number">10.1.3.</span> <span class="nav-text">开启ebpf</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%80%E5%90%AFdsr"><span class="nav-number">10.1.4.</span> <span class="nav-text">开启dsr</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IP%E5%9C%B0%E5%9D%80%E7%AE%A1%E7%90%86"><span class="nav-number">11.</span> <span class="nav-text">IP地址管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9D%99%E6%80%81ip"><span class="nav-number">11.1.</span> <span class="nav-text">静态ip</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8ipam%E9%87%8C%E9%9D%A2%E7%9A%84ip"><span class="nav-number">11.1.1.</span> <span class="nav-text">不使用ipam里面的ip</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Floating-IP-%E6%B5%AE%E5%8A%A8ip"><span class="nav-number">11.2.</span> <span class="nav-text">Floating IP(浮动ip)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IP%E9%A2%84%E7%95%99"><span class="nav-number">11.3.</span> <span class="nav-text">IP预留</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">11.4.</span> <span class="nav-text">优先级</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%A6%E5%AE%BD%E9%99%90%E5%88%B6"><span class="nav-number">12.</span> <span class="nav-text">带宽限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E5%AE%9AMAC%E5%9C%B0%E5%9D%80"><span class="nav-number">13.</span> <span class="nav-text">指定MAC地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E5%90%AFipv6%E6%94%AF%E6%8C%81"><span class="nav-number">14.</span> <span class="nav-text">开启ipv6支持</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9cni%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">14.1.</span> <span class="nav-text">修改cni配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9DS%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">14.2.</span> <span class="nav-text">修改DS环境变量</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">15.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Nature丿灵然</p>
  <div class="site-description" itemprop="description">Nature丿灵然的博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/NatureLR" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;NatureLR" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/1127711564@qq.com" title="E-Mail → 1127711564@qq.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.naturelr.cc/2023/05/10/%E5%9C%A8k8s%E4%B8%ADcalico%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Nature丿灵然">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nature丿灵然">
      <meta itemprop="description" content="Nature丿灵然的博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="在k8s中calico部署和使用 | Nature丿灵然">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          在k8s中calico部署和使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-10 16:41:00" itemprop="dateCreated datePublished" datetime="2023-05-10T16:41:00+08:00">2023-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-06 14:07:54" itemprop="dateModified" datetime="2024-03-06T14:07:54+08:00">2024-03-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico">calico</a>是k8s中常见的网络插件,非常灵活,支持ipip,vxlan隧道bgp路由以及ebpf,虚机k8s均可使用</p>
<span id="more"></span>

<h4 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h4><p><img src="/../images/calico.svg" alt="calico"></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>felix</td>
<td>状态报告，路由规划，接口管理，acl</td>
</tr>
<tr>
<td>bird</td>
<td>负责路由宣告，以及路由反射</td>
</tr>
<tr>
<td>confd</td>
<td>监控bgp变更，配置和更新bird的配置</td>
</tr>
<tr>
<td>储存插件</td>
<td>存储配置,有etcd和k8s两种选择</td>
</tr>
<tr>
<td>CNI插件</td>
<td>为pod配置网络</td>
</tr>
<tr>
<td>typha</td>
<td>为confd和felix和后端存储之间提供缓存等增加性能服务</td>
</tr>
<tr>
<td>calicoctl</td>
<td>命令行工具</td>
</tr>
<tr>
<td>dikastes</td>
<td>配合istio</td>
</tr>
</tbody></table>
<h5 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h5><h6 id="ippool"><a href="#ippool" class="headerlink" title="ippool"></a>ippool</h6><ul>
<li>ip池子,默认calico将会从池子中分配给podip</li>
</ul>
<h6 id="ipamblocks"><a href="#ipamblocks" class="headerlink" title="ipamblocks"></a>ipamblocks</h6><ul>
<li>从ippool里分割出来的ip段，为了减少路由数量，calico宣告路由时是以块为单位在pod所在的节点进行宣告的</li>
</ul>
<h4 id="部署calico-cni"><a href="#部署calico-cni" class="headerlink" title="部署calico cni"></a>部署calico cni</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://raw.githubusercontent.com/projectcalico/calico/v3.25.1/manifests/calico.yaml <span class="token parameter variable">-O</span>

kubectl apply <span class="token parameter variable">-f</span> calico.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="安装calicoctl"><a href="#安装calicoctl" class="headerlink" title="安装calicoctl"></a>安装calicoctl</h4><ul>
<li>calicoctl使用calic的命令行客户端攻击可以用来查看一些信息，有三种安装方法选一种即可</li>
</ul>
<h5 id="用容器的方式运行calicoctl"><a href="#用容器的方式运行calicoctl" class="headerlink" title="用容器的方式运行calicoctl"></a>用容器的方式运行calicoctl</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://raw.githubusercontent.com/projectcalico/calico/v3.25.1/manifests/calicoctl.yaml <span class="token parameter variable">-o</span> calicoctl.yaml

kubectl apply <span class="token parameter variable">-f</span> calicoctl.yaml

<span class="token builtin class-name">echo</span> <span class="token builtin class-name">alias</span> <span class="token assign-left variable">calicoctl</span><span class="token operator">=</span><span class="token string">"kubectl exec -i -n kube-system calicoctl -- /calicoctl"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用方法:<code>calicoctl version</code></p>
<h5 id="二进制文件"><a href="#二进制文件" class="headerlink" title="二进制文件"></a>二进制文件</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/projectcalico/calico/releases/latest/download/calicoctl-linux-amd64 <span class="token parameter variable">-o</span> calicoctl

<span class="token function">chmod</span> +x calicoctl
<span class="token function">mv</span> calicoctl /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用方法:<code>calicoctl version</code></p>
<h5 id="kubectl插件"><a href="#kubectl插件" class="headerlink" title="kubectl插件"></a>kubectl插件</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/projectcalico/calico/releases/latest/download/calicoctl-linux-amd64 <span class="token parameter variable">-o</span> kubectl-calico
<span class="token function">chmod</span> +x kubectl-calico
<span class="token function">mv</span> kubectl-calico /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>使用方法: <code>kubectl calico version</code></p>
<h5 id="calicoctl常用命令"><a href="#calicoctl常用命令" class="headerlink" title="calicoctl常用命令"></a>calicoctl常用命令</h5><ul>
<li>查看ipam分配情况</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl ipam show
<span class="token comment"># +----------+---------------+-----------+------------+--------------+</span>
<span class="token comment"># | GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |</span>
<span class="token comment"># +----------+---------------+-----------+------------+--------------+</span>
<span class="token comment"># | IP Pool  | 10.244.0.0/16 |     65536 | 10 (0%)    | 65526 (100%) |</span>
<span class="token comment"># +----------+---------------+-----------+------------+--------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看blocks分配情况</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl ipam show --show-blocks
<span class="token comment">#+----------+-------------------+-----------+------------+--------------+</span>
<span class="token comment">#| GROUPING |       CIDR        | IPS TOTAL | IPS IN USE |   IPS FREE   |</span>
<span class="token comment">#+----------+-------------------+-----------+------------+--------------+</span>
<span class="token comment">#| IP Pool  | 10.244.0.0/16     |     65536 | 10 (0%)    | 65526 (100%) |</span>
<span class="token comment">#| Block    | 10.244.120.64/26  |        64 | 5 (8%)     | 59 (92%)     |</span>
<span class="token comment">#| Block    | 10.244.205.192/26 |        64 | 5 (8%)     | 59 (92%)     |</span>
<span class="token comment">#+----------+-------------------+-----------+------------+--------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看ippool</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl get ippool <span class="token parameter variable">-o</span> wide
<span class="token comment"># NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR   </span>
<span class="token comment"># default-ipv4-ippool   10.244.0.0/16   true   Always     Never       false      false              all() </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="IPIP模式"><a href="#IPIP模式" class="headerlink" title="IPIP模式"></a>IPIP模式</h4><p>calico的网络模式<code>默认</code>是IPIP模式</p>
<ul>
<li>通过calicoctl查看ippool的<code>IPIPMODE</code>字段，如下</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl get ippool <span class="token parameter variable">-o</span> wide
<span class="token comment"># NAME                  CIDR               NAT     IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="token comment"># default-ipv4-ippool   10.244.0.0/16      true    Always      Never       false      false              all()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>启动ipipmode分为两种，一种是<code>Always</code>，还有一种<code>CrossSubnet</code><ul>
<li>always，无论是否跨子网都通过ipip来通讯</li>
<li>CrossSubnet，只有在跨子网时使用ipip模式</li>
<li>Never,关闭从不使用ipip模式</li>
</ul>
</li>
</ul>
<h5 id="ipip路径分析"><a href="#ipip路径分析" class="headerlink" title="ipip路径分析"></a>ipip路径分析</h5><ul>
<li>部署一个nginx</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">k get po <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx <span class="token parameter variable">-o</span> wide          
<span class="token comment"># NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span>
<span class="token comment"># nginx-7fc57c59f7-4nxhh   1/1     Running   0          6m30s   10.244.120.68    minikube       &lt;none>           &lt;none></span>
<span class="token comment"># nginx-7fc57c59f7-hf2g6   1/1     Running   0          6m43s   10.244.205.195   minikube-m02   &lt;none>           &lt;none></span>
<span class="token comment"># nginx-7fc57c59f7-rcdtw   1/1     Running   0          6m30s   10.244.205.196   minikube-m02   &lt;none>           &lt;none></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>进入一个nginx的pod去ping另一个容器</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> nginx-7fc57c59f7-4nxhh -- <span class="token function">ping</span> <span class="token number">10.244</span>.205.195<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="ipip-pod到pod所在的node"><a href="#ipip-pod到pod所在的node" class="headerlink" title="ipip-pod到pod所在的node"></a>ipip-pod到pod所在的node</h6><ul>
<li>查看容器的网卡和路由信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> nginx-7fc57c59f7-4nxhh -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">"ip addr;ip r"</span>
<span class="token comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span>
<span class="token comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span class="token comment">#     inet 127.0.0.1/8 scope host lo</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span>
<span class="token comment"># 2: tunl0@NONE: &lt;NOARP> mtu 1480 qdisc noop state DOWN qlen 1000</span>
<span class="token comment">#     link/ipip 0.0.0.0 brd 0.0.0.0</span>
<span class="token comment"># 3: ip6tnl0@NONE: &lt;NOARP> mtu 1452 qdisc noop state DOWN qlen 1000</span>
<span class="token comment">#     link/tunnel6 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00 brd 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00</span>
<span class="token comment"># 5: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 65515 qdisc noqueue state UP </span>
<span class="token comment">#     link/ether fe:bb:51:af:03:a8 brd ff:ff:ff:ff:ff:ff</span>
<span class="token comment">#     inet 10.244.120.68/32 scope global eth0</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span>

<span class="token comment"># default via 169.254.1.1 dev eth0 </span>
<span class="token comment"># 169.254.1.1 dev eth0 scope link </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>从上面的信息比较难以理解的是路由的网关是169.254.1.1，169.254.0.0&#x2F;16为保留地址一般用于dhcp获取，而calico则将容器的默认路由设置为此,当容器发现目标地址不是本ip段时，会将流量发送给网关，这时需要知道网关的mac地址<br>这里calico将网关设置为169.254.1.1而没有任何一个网卡是169.254.1.1,其实是因为开了arp_proxy代答,具体使用了pod的veth的外面的网卡,这样流量就通过二层到达主机<br>官方的<a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/reference/faq#why-cant-i-see-the-16925411-address-mentioned-above-on-my-host">FAQ</a></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> cali1143a22bb0c <span class="token function">host</span> <span class="token number">10.244</span>.120.68 <span class="token parameter variable">-ennnvv</span>
<span class="token comment"># ...</span>
<span class="token comment"># 09:21:15.764922 fe:bb:51:af:03:a8 > ee:ee:ee:ee:ee:ee, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Request who-has 169.254.1.1 tell 10.244.120.68, length 28</span>
<span class="token comment"># 09:21:15.764944 ee:ee:ee:ee:ee:ee > fe:bb:51:af:03:a8, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee, length 28</span>
<span class="token comment"># ...</span>

<span class="token function">cat</span> /proc/sys/net/ipv4/conf/cali1143a22bb0c/proxy_arp
<span class="token comment"># 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>veth抓包</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> tcpdump <span class="token parameter variable">-i</span> cali1143a22bb0c  <span class="token function">host</span> <span class="token number">10.244</span>.120.68 <span class="token parameter variable">-ennnvv</span>
<span class="token comment"># tcpdump: listening on cali1143a22bb0c, link-type EN10MB (Ethernet), capture size 262144 bytes</span>
<span class="token comment"># 09:39:53.417261 fe:bb:51:af:03:a8 > ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 37455, offset 0, flags [DF], proto ICMP (1), length 84)</span>
<span class="token comment">#     10.244.120.68 > 10.244.205.195: ICMP echo request, id 15617, seq 12, length 64</span>
<span class="token comment"># 09:39:53.417585 ee:ee:ee:ee:ee:ee > fe:bb:51:af:03:a8, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 62, id 24660, offset 0, flags [none], proto ICMP (1), length 84)</span>
<span class="token comment">#     10.244.205.195 > 10.244.120.68: ICMP echo reply, id 15617, seq 12, length 64</span>
<span class="token comment"># 09:39:54.417872 fe:bb:51:af:03:a8 > ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 38148, offset 0, flags [DF], proto ICMP (1), length 84)</span>
<span class="token comment">#     10.244.120.68 > 10.244.205.195: ICMP echo request, id 15617, seq 13, length 64</span>
<span class="token comment"># 09:39:54.418089 ee:ee:ee:ee:ee:ee > fe:bb:51:af:03:a8, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 62, id 24786, offset 0, flags [none], proto ICMP (1), length 84)</span>
<span class="token comment">#     10.244.205.195 > 10.244.120.68: ICMP echo reply, id 15617, seq 13, length 64</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="ipip-pod所在的node到目标所在的node的pod"><a href="#ipip-pod所在的node到目标所在的node的pod" class="headerlink" title="ipip-pod所在的node到目标所在的node的pod"></a>ipip-pod所在的node到目标所在的node的pod</h6><ul>
<li>查看minikube上的路由</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r
<span class="token comment"># default via 192.168.49.1 dev eth0 </span>
<span class="token comment"># blackhole 10.244.120.64/26 proto bird </span>
<span class="token comment"># 10.244.120.65 dev califc4f8273134 scope link </span>
<span class="token comment"># 10.244.120.66 dev cali54e305c20b5 scope link </span>
<span class="token comment"># 10.244.120.67 dev cali00c313c8253 scope link </span>
<span class="token comment"># 10.244.120.68 dev cali1143a22bb0c scope link  # 这个就是我们进行ping的pod的路由</span>
<span class="token comment"># 10.244.205.192/26 via 192.168.49.3 dev tunl0 proto bird onlink  # 这个是minikube-m02这个节点上的路由，如果要访问minikube-m02上的pod则经过本路由</span>
<span class="token comment"># 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown </span>
<span class="token comment"># 192.168.49.0/24 dev eth0 proto kernel scope link src 192.168.49.2 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>隧道抓包</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> tunl0 <span class="token function">host</span> <span class="token number">10.244</span>.120.68 <span class="token parameter variable">-ennnvv</span>
<span class="token comment"># tcpdump: listening on tunl0, link-type RAW (Raw IP), capture size 262144 bytes</span>
<span class="token comment"># 09:40:55.459832 ip: (tos 0x0, ttl 63, id 114, offset 0, flags [DF], proto ICMP (1), length 84) 10.244.120.68 > 10.244.205.195: ICMP echo request, id 15617, seq 74, length 64</span>
<span class="token comment"># 09:40:55.460009 ip: (tos 0x0, ttl 63, id 58352, offset 0, flags [none], proto ICMP (1), length 84) 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 15617, seq 74, length 64</span>
<span class="token comment"># 09:40:56.460530 ip: (tos 0x0, ttl 63, id 495, offset 0, flags [DF], proto ICMP (1), length 84) 10.244.120.68 > 10.244.205.195: ICMP echo request, id 15617, seq 75, length 64</span>
<span class="token comment"># 09:40:56.460780 ip: (tos 0x0, ttl 63, id 59235, offset 0, flags [none], proto ICMP (1), length 84) 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 15617, seq 75, length 64</span>
<span class="token comment"># 09:40:57.461367 ip: (tos 0x0, ttl 63, id 979, offset 0, flags [DF], proto ICMP (1), length 84) 10.244.120.68 > 10.244.205.195: ICMP echo request, id 15617, seq 76, length 64</span>
<span class="token comment"># 09:40:57.461510 ip: (tos 0x0, ttl 63, id 59858, offset 0, flags [none], proto ICMP (1), length 84) 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 15617, seq 76, length 64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>到此pod的流量通过ipip封装发送到目标pod所在的node上,目标node将ipip包解封包，然后查找路由表发送到目标pod的veth网卡中</p>
</li>
<li><p>登录另一个node</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">minikube <span class="token function">ssh</span> <span class="token parameter variable">--node</span><span class="token operator">=</span><span class="token string">"minikube-m02"</span>
<span class="token comment"># Last login: Tue May 16 10:37:54 2023 from 192.168.49.1</span>
<span class="token comment"># docker@minikube-m02:~$ </span>
<span class="token function">sudo</span> <span class="token function">su</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过ip找到对应的网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">10.244</span>.205.195
<span class="token comment"># 10.244.205.195 dev cali614e1c7b24e scope link </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>抓包对应的网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> cali614e1c7b24e 
<span class="token comment"># tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="token comment"># listening on cali614e1c7b24e, link-type EN10MB (Ethernet), capture size 262144 bytes</span>
<span class="token comment"># 10:50:48.678597 IP 10.244.120.68 > 10.244.205.195: ICMP echo request, id 21761, seq 88, length 64</span>
<span class="token comment"># 10:50:48.678615 IP 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 21761, seq 88, length 64</span>
<span class="token comment"># 10:50:49.678987 IP 10.244.120.68 > 10.244.205.195: ICMP echo request, id 21761, seq 89, length 64</span>
<span class="token comment"># 10:50:49.679010 IP 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 21761, seq 89, length 64</span>
<span class="token comment"># 10:50:50.680533 IP 10.244.120.68 > 10.244.205.195: ICMP echo request, id 21761, seq 90, length 64</span>
<span class="token comment"># 10:50:50.680595 IP 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 21761, seq 90, length 64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>抓包ipip隧道网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> tunl0 
<span class="token comment"># tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="token comment"># listening on tunl0, link-type RAW (Raw IP), capture size 262144 bytes</span>
<span class="token comment"># 10:51:06.694392 IP 10.244.120.68 > 10.244.205.195: ICMP echo request, id 21761, seq 106, length 64</span>
<span class="token comment"># 10:51:06.694504 IP 10.244.205.195 > 10.244.120.68: ICMP echo reply, id 21761, seq 106, length 64</span>
<span class="token comment"># 10:51:07.695538 IP 10.244.120.68 > 10.244.205.195: ICMP echo request, id 21761, seq 107, length 64</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过以上抓包可以确定流量的路径</li>
</ul>
<h6 id="2个pod在同一个node上"><a href="#2个pod在同一个node上" class="headerlink" title="2个pod在同一个node上"></a>2个pod在同一个node上</h6><ul>
<li><p>当目标pod和源pod在同一个node上执行通过node上的路由到对应的veth网卡,不经过隧道</p>
</li>
<li><p>这次ping一个在相同node上的pod的ip</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get po whoami-7c88bd4c6f-7tc5b <span class="token parameter variable">-o</span> wide                   
<span class="token comment"># NAME                      READY   STATUS    RESTARTS   AGE     IP              NODE       NOMINATED NODE   READINESS GATES</span>
<span class="token comment"># whoami-7c88bd4c6f-7tc5b   1/1     Running   0          3h18m   10.244.120.67   minikube   &lt;none>           &lt;none></span>

kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> nginx-7fc57c59f7-4nxhh -- <span class="token function">ping</span> <span class="token number">10.244</span>.120.67
<span class="token comment"># PING 10.244.120.67 (10.244.120.67): 56 data bytes</span>
<span class="token comment"># PING 10.244.120.67 (10.244.120.67): 56 data bytes</span>
<span class="token comment"># 64 bytes from 10.244.120.67: seq=0 ttl=63 time=1.777 ms</span>
<span class="token comment"># 64 bytes from 10.244.120.67: seq=1 ttl=63 time=0.542 ms</span>
<span class="token comment"># 64 bytes from 10.244.120.67: seq=2 ttl=63 time=0.132 ms</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>直接抓包隧道发现没有流量</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">minikube <span class="token function">ssh</span> 
<span class="token comment"># Last login: Tue May 16 10:41:40 2023 from 192.168.49.1</span>
<span class="token function">sudo</span> <span class="token function">su</span>
tcpdump <span class="token parameter variable">-i</span> tunl0
<span class="token comment"># tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="token comment"># listening on tunl0, link-type RAW (Raw IP), capture size 262144 bytes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过路由表找到对应的网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">10.244</span>.120.67
<span class="token number">10.244</span>.120.67 dev cali00c313c8253 scope <span class="token function">link</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>抓包目标的网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> cali00c313c8253
<span class="token comment"># tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="token comment"># listening on cali00c313c8253, link-type EN10MB (Ethernet), capture size 262144 bytes</span>
<span class="token comment"># 10:47:39.884507 IP 10.244.120.68 > 10.244.120.67: ICMP echo request, id 19969, seq 141, length 64</span>
<span class="token comment"># 10:47:39.884649 IP 10.244.120.67 > 10.244.120.68: ICMP echo reply, id 19969, seq 141, length 64</span>
<span class="token comment"># 10:47:40.885829 IP 10.244.120.68 > 10.244.120.67: ICMP echo request, id 19969, seq 142, length 64</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过以上抓包可以发现并没有经过隧道，而是直接路由到了目标的网卡</li>
</ul>
<h6 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h6><p><img src="/../images/calico-ipip-1.png" alt="calico-ipip"></p>
<h4 id="VXLAN模式"><a href="#VXLAN模式" class="headerlink" title="VXLAN模式"></a>VXLAN模式</h4><h5 id="开启vxlan模式"><a href="#开启vxlan模式" class="headerlink" title="开启vxlan模式"></a>开启vxlan模式</h5><ul>
<li><p>修改ippool中<code>VXLANMODE</code>字段为<code>Always</code>,<code>IPIPMODE</code>改为<code>Never</code>,其中<code>VXLANMODE</code>中的也有<code>CrossSubnet</code>只在跨子网时使用</p>
</li>
<li><p>修改calico-node的环境变量</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改环境变量</span>
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">CALICO_IPV4POOL_IPIP</span><span class="token operator">=</span>Never
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">CALICO_IPV4POOL_VXLAN</span><span class="token operator">=</span>Always<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>关闭关闭bird</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将calico_backend修改为vxlan</span>
<span class="token comment"># calico_backend: vxlan</span>
kubectl edit cm -nkube-system calico-config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>关闭bird的健康检查</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system edit ds calico-node<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">exec</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>live
   <span class="token comment"># - -bird-live</span>
<span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">exec</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
    <span class="token comment"># - -bird-ready</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>ready<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="vxlan路径分析"><a href="#vxlan路径分析" class="headerlink" title="vxlan路径分析"></a>vxlan路径分析</h5><ul>
<li><p>依然使用之前的nginx来做测试</p>
</li>
<li><p>节点路由</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r
<span class="token comment"># default via 192.168.49.1 dev eth0 </span>
<span class="token comment"># 10.244.0.192/26 via 10.244.0.192 dev vxlan.calico onlink </span>
<span class="token comment"># blackhole 10.244.120.64/26 proto 80 </span>
<span class="token comment"># 10.244.120.65 dev califc4f8273134 scope link </span>
<span class="token comment"># 10.244.120.66 dev cali54e305c20b5 scope link </span>
<span class="token comment"># 10.244.120.68 dev cali1143a22bb0c scope link </span>
<span class="token comment"># 10.244.205.192/26 via 10.244.0.192 dev vxlan.calico onlink  之前是ipip的tunl0网卡变更为vxlan的网卡</span>
<span class="token comment"># 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown </span>
<span class="token comment"># 192.168.49.0/24 dev eth0 proto kernel scope link src 192.168.49.2 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看vxlan.calico网卡信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> <span class="token parameter variable">-s</span>  addr show vxlan.calico
<span class="token comment">#863: vxlan.calico: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65485 qdisc noqueue state UNKNOWN group default </span>
<span class="token comment">#    link/ether 66:66:b0:7b:5c:e1 brd ff:ff:ff:ff:ff:ff</span>
<span class="token comment">#    inet 10.244.120.70/32 scope global vxlan.calico</span>
<span class="token comment">#       valid_lft forever preferred_lft forever</span>
<span class="token comment">#    RX: bytes  packets  errors  dropped overrun mcast   </span>
<span class="token comment">#    23094      267      0       0       0       0       </span>
<span class="token comment">#    TX: bytes  packets  errors  dropped carrier collsns </span>
<span class="token comment">#    22374      268      0       0       0       0       </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>搜下这个ip发现他作用为vxlan的网卡ip</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl ipam show <span class="token parameter variable">--ip</span><span class="token operator">=</span><span class="token number">10.244</span>.120.70
<span class="token comment">#IP 10.244.120.70 is in use</span>
<span class="token comment">#Attributes:</span>
<span class="token comment">#  node: minikube</span>
<span class="token comment">#  type: vxlanTunnelAddress</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="vxlan-pod到node"><a href="#vxlan-pod到node" class="headerlink" title="vxlan-pod到node"></a>vxlan-pod到node</h6><ul>
<li>从上面的网卡和路由信息可以看到calico只是修改了到其他节点pod的通讯方式，从ipip隧道改为vlxan隧道然后修改路由</li>
<li>所以后pod到node的方式其实没有变化和<a href="#ipip-pod%E5%88%B0pod%E6%89%80%E5%9C%A8%E7%9A%84node">ipip</a>模式是一样的</li>
</ul>
<h6 id="vxlan-pod到另一个node的pod"><a href="#vxlan-pod到另一个node的pod" class="headerlink" title="vxlan-pod到另一个node的pod"></a>vxlan-pod到另一个node的pod</h6><ul>
<li><p>依然开始长ping</p>
</li>
<li><p>抓包vxlan网卡</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token parameter variable">-i</span> vxlan.calico <span class="token parameter variable">-eenn</span>
<span class="token comment"># tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="token comment"># listening on vxlan.calico, link-type EN10MB (Ethernet), capture size 262144 bytes</span>
<span class="token comment"># 09:22:33.108257 66:66:b0:7b:5c:e1 > 66:9f:82:63:75:c1, ethertype IPv4 (0x0800), length 98: 10.244.120.68 > 10.244.205.196: ICMP echo request, id 30721, seq 33, length 64</span>
<span class="token comment"># 09:22:33.108388 66:9f:82:63:75:c1 > 66:66:b0:7b:5c:e1, ethertype IPv4 (0x0800), length 98: 10.244.205.196 > 10.244.120.68: ICMP echo reply, id 30721, seq 33, length 64</span>
<span class="token comment"># 09:22:34.109579 66:66:b0:7b:5c:e1 > 66:9f:82:63:75:c1, ethertype IPv4 (0x0800), length 98: 10.244.120.68 > 10.244.205.196: ICMP echo request, id 30721, seq 34, length 64</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>可以看到到vxlan网卡有我们长ping的数据包，可以确定不同node上的pod是通过vxlan来通讯</li>
<li><code>66:66:b0:7b:5c:e1</code>为源头pod所在node的vxlan网卡mac</li>
<li><code>66:9f:82:63:75:c1</code>为目标pod所在node的vxlan网卡mac</li>
</ul>
<h5 id="vxlan-小结"><a href="#vxlan-小结" class="headerlink" title="vxlan-小结"></a>vxlan-小结</h5><ul>
<li>vxlan模式下知识变换了从一个node到另一个node的方式，从之前的ipip变为vxlan</li>
<li>pod到node没有变化</li>
</ul>
<p><img src="/../images/calico-vxlan-1.png" alt="calico-ipip"></p>
<h4 id="BGP模式-full-mesh"><a href="#BGP模式-full-mesh" class="headerlink" title="BGP模式(full mesh)"></a>BGP模式(full mesh)</h4><blockquote>
<p>BGP是一个使用广泛的路由协议，分为2种一种是不同as号的ebgp已经同as号的ibgp，这里使用的是ibgp</p>
</blockquote>
<div class="note warning"><p>注意此模式节点只能在同一个子网中进行，如果节点不在同一个子网请参与<a href="#%E8%B7%A8"></a></p>
</div>

<h5 id="开启BGP模式"><a href="#开启BGP模式" class="headerlink" title="开启BGP模式"></a>开启BGP模式</h5><blockquote>
<p>开启bgp模式基本思路就是将<code>ipip</code>和<code>vxlan</code>模式都给关闭了</p>
</blockquote>
<ul>
<li><p>修改ippool中<code>VXLANMODE</code>字段为<code>Never</code>,<code>IPIPMODE</code>改为<code>Never</code></p>
</li>
<li><p>修改calico-node的环境变量</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改环境变量</span>
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">CALICO_IPV4POOL_IPIP</span><span class="token operator">=</span>Never
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">CALICO_IPV4POOL_VXLAN</span><span class="token operator">=</span>Never<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如果关闭bird需要开启bird</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将calico_backend修改为bird</span>
<span class="token comment"># calico_backend: bird</span>
kubectl edit cm -nkube-system calico-config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如果关闭了bird的健康检查则需要开启bird的健康检查</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system edit ds calico-node<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">exec</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>live
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>live <span class="token comment"># 打开</span>
<span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">exec</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>ready
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>ready <span class="token comment"># 打开</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="BGP模式路径分析"><a href="#BGP模式路径分析" class="headerlink" title="BGP模式路径分析"></a>BGP模式路径分析</h5><ul>
<li>查看路由,可以发现跨节点通讯使用路由</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r 
<span class="token comment"># default via 192.168.49.1 dev eth0 </span>
<span class="token comment"># 10.244.0.192/26 via 192.168.49.3 dev eth0 proto bird </span>
<span class="token comment"># blackhole 10.244.120.64/26 proto bird </span>
<span class="token comment"># 10.244.120.65 dev califc4f8273134 scope link </span>
<span class="token comment"># 10.244.120.66 dev cali54e305c20b5 scope link </span>
<span class="token comment"># 10.244.120.68 dev cali1143a22bb0c scope link </span>
<span class="token comment"># 10.244.205.192/26 via 192.168.49.3 dev eth0 proto bird # 这里已经变成了bird了</span>
<span class="token comment"># 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown </span>
<span class="token comment"># 192.168.49.0/24 dev eth0 proto kernel scope link src 192.168.49.2 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看网卡,可以发现没有vxlan的网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> addr
<span class="token comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="token comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span class="token comment">#     inet 127.0.0.1/8 scope host lo</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span>
<span class="token comment"># 2: tunl0@NONE: &lt;NOARP,UP,LOWER_UP> mtu 65515 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="token comment">#     link/ipip 0.0.0.0 brd 0.0.0.0</span>
<span class="token comment"># 3: ip6tnl0@NONE: &lt;NOARP> mtu 1452 qdisc noop state DOWN group default qlen 1000</span>
<span class="token comment">#     link/tunnel6 :: brd ::</span>
<span class="token comment"># 4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default </span>
<span class="token comment">#     link/ether 02:42:7a:58:36:29 brd ff:ff:ff:ff:ff:ff</span>
<span class="token comment">#     inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span>
<span class="token comment"># 5: califc4f8273134@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default </span>
<span class="token comment">#     link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 1</span>
<span class="token comment"># 6: cali54e305c20b5@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default </span>
<span class="token comment">#     link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
<span class="token comment"># 10: cali1143a22bb0c@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65515 qdisc noqueue state UP group default </span>
<span class="token comment">#     link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 4</span>
<span class="token comment"># 16: eth0@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65535 qdisc noqueue state UP group default </span>
<span class="token comment">#     link/ether 02:42:c0:a8:31:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="token comment">#     inet 192.168.49.2/24 brd 192.168.49.255 scope global eth0</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过birdcl查看路由表</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> calico-node-9pwnj <span class="token parameter variable">-c</span> calico-node -- /bin/bash

birdcl
show route

<span class="token comment"># bird> show route</span>
<span class="token comment"># 0.0.0.0/0          via 192.168.49.1 on eth0 [kernel1 07:27:41] * (10)</span>
<span class="token comment"># 10.244.205.192/26  via 192.168.49.3 on eth0 [Mesh_192_168_49_3 07:27:41] * (100/0) [i]</span>
<span class="token comment"># 192.168.49.0/24    dev eth0 [direct1 07:27:40] * (240)</span>
<span class="token comment"># 10.244.120.64/26   blackhole [static1 07:27:40] * (200)</span>
<span class="token comment"># 10.244.120.65/32   dev califc4f8273134 [kernel1 07:27:41] * (10)</span>
<span class="token comment"># 10.244.120.66/32   dev cali54e305c20b5 [kernel1 07:27:41] * (10)</span>
<span class="token comment"># 10.244.120.68/32   dev cali1143a22bb0c [kernel1 07:27:41] * (10)</span>
<span class="token comment"># 10.244.0.192/26    via 192.168.49.3 on eth0 [Mesh_192_168_49_3 07:27:41] * (100/0) [i]</span>
<span class="token comment"># 172.17.0.0/16      dev docker0 [direct1 07:27:40] * (240)</span>
<span class="token comment"># bird> </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过birdcl查bgp邻居状态</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">birdcl show protocols
<span class="token comment"># root@minikube /]# birdcl  show protocols</span>
<span class="token comment"># BIRD v0.3.3+birdv1.6.8 ready.</span>
<span class="token comment"># name     proto    table    state  since       info</span>
<span class="token comment"># static1  Static   master   up     07:27:40    </span>
<span class="token comment"># kernel1  Kernel   master   up     07:27:40    </span>
<span class="token comment"># device1  Device   master   up     07:27:40    </span>
<span class="token comment"># direct1  Direct   master   up     07:27:40    </span>
<span class="token comment"># Mesh_192_168_49_3 BGP      master   up     07:27:53    Established  bgp邻居状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看bgp详细信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">birdcl show protocols all Mesh_192_168_49_2
<span class="token comment"># root@minikube-m02 /]# birdcl show protocols all Mesh_192_168_49_2</span>
<span class="token comment"># BIRD v0.3.3+birdv1.6.8 ready.</span>
<span class="token comment"># name     proto    table    state  since       info</span>
<span class="token comment"># Mesh_192_168_49_2 BGP      master   up     07:27:53    Established   </span>
<span class="token comment">#   Description:    Connection to BGP peer</span>
<span class="token comment">#   Preference:     100</span>
<span class="token comment">#   Input filter:   ACCEPT</span>
<span class="token comment">#   Output filter:  calico_export_to_bgp_peers</span>
<span class="token comment">#   Routes:         1 imported, 2 exported, 1 preferred</span>
<span class="token comment">#   Route change stats:     received   rejected   filtered    ignored   accepted</span>
<span class="token comment">#     Import updates:              4          0          0          0          4</span>
<span class="token comment">#     Import withdraws:            3          0        ---          0          3</span>
<span class="token comment">#     Export updates:             17          4          8        ---          5</span>
<span class="token comment">#     Export withdraws:            8        ---        ---        ---          3</span>
<span class="token comment">#   BGP state:          Established</span>
<span class="token comment">#     Neighbor address: 192.168.49.2</span>
<span class="token comment">#     Neighbor AS:      64512</span>
<span class="token comment">#     Neighbor ID:      192.168.49.2</span>
<span class="token comment">#     Neighbor caps:    refresh enhanced-refresh restart-able llgr-aware AS4 add-path-rx add-path-tx</span>
<span class="token comment">#     Session:          internal multihop AS4 add-path-rx add-path-tx</span>
<span class="token comment">#     Source address:   192.168.49.3</span>
<span class="token comment">#     Hold timer:       157/240</span>
<span class="token comment">#     Keepalive timer:  67/80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>总体而言比较简单，直接通过路由到目标pod对应的节点</li>
</ul>
<h5 id="bgp小结"><a href="#bgp小结" class="headerlink" title="bgp小结"></a>bgp小结</h5><ul>
<li>每个节点之间通过bgp宣告路由</li>
</ul>
<p><img src="/../images/calico-bgp-1.png" alt="calico-bgp"></p>
<p><img src="/../images/calico-bgp-2.png" alt="calico-bgp"></p>
<h4 id="BGP-RR模式-Route-reflectors"><a href="#BGP-RR模式-Route-reflectors" class="headerlink" title="BGP-RR模式(Route reflectors)"></a>BGP-RR模式(Route reflectors)</h4><p><img src="/../images/calico-bgp-4.png" alt="calico-bgp"></p>
<ul>
<li>从节点中选取一部分节点作为bgp路由反射器以减少bgp对等体数量</li>
</ul>
<h5 id="路由反射部署方案"><a href="#路由反射部署方案" class="headerlink" title="路由反射部署方案"></a>路由反射部署方案</h5><blockquote>
<p>测试环境为4个节点的minikube集群</p>
</blockquote>
<ul>
<li><p>部署路由反射器有很多方法:</p>
<ul>
<li><ol>
<li>在集群外的机器中部署bird</li>
</ol>
</li>
<li><ol start="2">
<li>在k8s中选择专门的节点</li>
</ol>
</li>
<li><ol start="3">
<li>部署专门的calico-node容器作为反射器</li>
</ol>
</li>
</ul>
</li>
<li><p>很显然直接在集群中部署专门的节点作为反射器比较方便且容易管理</p>
</li>
<li><p>选择2个节点作为反射器，这里我选择后2个</p>
</li>
</ul>
<h5 id="确认现在的为bgp的mesh模式"><a href="#确认现在的为bgp的mesh模式" class="headerlink" title="确认现在的为bgp的mesh模式"></a>确认现在的为bgp的mesh模式</h5><div class="note warning"><p>需要注意<code>calicoctl node status</code>这个需要再部署calico的节点上执行。。。。有点唐突</p>
</div>

<ul>
<li>查看当前bgp邻居,可以发现已经与另外三个节点建立了邻居关系</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl <span class="token function">node</span> status
<span class="token comment"># root@minikube:~# calicoctl node status</span>
<span class="token comment"># Calico process is running.</span>
<span class="token comment"># </span>
<span class="token comment"># IPv4 BGP status</span>
<span class="token comment"># +--------------+-------------------+-------+----------+-------------+</span>
<span class="token comment"># | PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span>
<span class="token comment"># +--------------+-------------------+-------+----------+-------------+</span>
<span class="token comment"># | 192.168.49.3 | node-to-node mesh | up    | 18:13:08 | Established |</span>
<span class="token comment"># | 192.168.49.4 | node-to-node mesh | up    | 19:37:12 | Established |</span>
<span class="token comment"># | 192.168.49.5 | node-to-node mesh | up    | 02:27:27 | Established |</span>
<span class="token comment"># +--------------+-------------------+-------+----------+-------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl get nodes <span class="token parameter variable">-o</span> wide 
<span class="token comment"># NAME           ASN       IPV4              IPV6   </span>
<span class="token comment"># minikube       (64512)   192.168.49.2/24          </span>
<span class="token comment"># minikube-m02   (64512)   192.168.49.3/24          </span>
<span class="token comment"># minikube-m03   (64512)   192.168.49.4/24   # 作为反射器       </span>
<span class="token comment"># minikube-m04   (64512)   192.168.49.5/24   # 作为反射器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="指定节点作为反射器"><a href="#指定节点作为反射器" class="headerlink" title="指定节点作为反射器"></a>指定节点作为反射器</h5><ul>
<li>导出<code>calico/node</code>资源</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl get nodes minikube-m03 <span class="token parameter variable">-o</span> yaml <span class="token operator">></span> minikube-m03.yaml
calicoctl get nodes minikube-m04 <span class="token parameter variable">-o</span> yaml <span class="token operator">></span> minikube-m04.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>在导出的文件中添加下面的字段</li>
</ul>
<blockquote>
<p>routeReflectorClusterID应该是为了防止路由环路</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># ...</span>
  <span class="token key atrule">bgp</span><span class="token punctuation">:</span>
    <span class="token key atrule">ipv4Address</span><span class="token punctuation">:</span> 192.168.49.4/24
    <span class="token key atrule">routeReflectorClusterID</span><span class="token punctuation">:</span> 1.0.0.1
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>应用修改</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl replace <span class="token parameter variable">-f</span> minikube-m03.yaml
<span class="token comment"># Successfully replaced 1 'Node' resource(s)</span>
calicoctl replace <span class="token parameter variable">-f</span> minikube-m04.yaml
<span class="token comment"># Successfully replaced 1 'Node' resource(s)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>在指定的节点打上标签</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl label <span class="token function">node</span> minikube-m04 minikube-m03 route-reflector<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="配置bgp对等体"><a href="#配置bgp对等体" class="headerlink" title="配置bgp对等体"></a>配置bgp对等体</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> BGPPeer
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>rr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
  <span class="token key atrule">peerSelector</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>reflector == 'true'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>修改bgp配置，关闭mesh模式</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> BGPConfiguration
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">logSeverityScreen</span><span class="token punctuation">:</span> Info
  <span class="token key atrule">nodeToNodeMeshEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">asNumber</span><span class="token punctuation">:</span> <span class="token number">63400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="查看节点bgp状态"><a href="#查看节点bgp状态" class="headerlink" title="查看节点bgp状态"></a>查看节点bgp状态</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># rr模式的节点上</span>
root@minikube-m03:~<span class="token comment"># calicoctl node status</span>
Calico process is running.

IPv4 BGP status
+--------------+---------------+-------+----------+-------------+
<span class="token operator">|</span> PEER ADDRESS <span class="token operator">|</span>   PEER TYPE   <span class="token operator">|</span> STATE <span class="token operator">|</span>  SINCE   <span class="token operator">|</span>    INFO     <span class="token operator">|</span>
+--------------+---------------+-------+----------+-------------+
<span class="token operator">|</span> <span class="token number">192.168</span>.49.2 <span class="token operator">|</span> <span class="token function">node</span> specific <span class="token operator">|</span> up    <span class="token operator">|</span> 03:17:41 <span class="token operator">|</span> Established <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.49.3 <span class="token operator">|</span> <span class="token function">node</span> specific <span class="token operator">|</span> up    <span class="token operator">|</span> 03:17:41 <span class="token operator">|</span> Established <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.49.5 <span class="token operator">|</span> <span class="token function">node</span> specific <span class="token operator">|</span> up    <span class="token operator">|</span> 03:17:41 <span class="token operator">|</span> Established <span class="token operator">|</span>
+--------------+---------------+-------+----------+-------------+
<span class="token comment"># 普通节点</span>
root@minikube:~<span class="token comment"># calicoctl node status </span>
Calico process is running.

IPv4 BGP status
+--------------+---------------+-------+----------+-------------+
<span class="token operator">|</span> PEER ADDRESS <span class="token operator">|</span>   PEER TYPE   <span class="token operator">|</span> STATE <span class="token operator">|</span>  SINCE   <span class="token operator">|</span>    INFO     <span class="token operator">|</span>
+--------------+---------------+-------+----------+-------------+
<span class="token operator">|</span> <span class="token number">192.168</span>.49.4 <span class="token operator">|</span> <span class="token function">node</span> specific <span class="token operator">|</span> up    <span class="token operator">|</span> 03:17:41 <span class="token operator">|</span> Established <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.49.5 <span class="token operator">|</span> <span class="token function">node</span> specific <span class="token operator">|</span> up    <span class="token operator">|</span> 03:17:43 <span class="token operator">|</span> Established <span class="token operator">|</span>
+--------------+---------------+-------+----------+-------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="BGP-TOR路由"><a href="#BGP-TOR路由" class="headerlink" title="BGP-TOR路由"></a>BGP-TOR路由</h4><p><code>Top of Rack</code>机架上面的交换机</p>
<p><img src="/../images/calico-bgp-5.png" alt="calico-bgp"></p>
<ul>
<li>这个方案中所有的节点将bgp信息宣告给tor交换机由交换机负责bgp宣告</li>
<li>需要硬件交换机和路由器中整体部署bgp网络，然后宣告给这个网络</li>
</ul>
<h4 id="IPIP-VXLAN跨子网模式"><a href="#IPIP-VXLAN跨子网模式" class="headerlink" title="IPIP&#x2F;VXLAN跨子网模式"></a>IPIP&#x2F;VXLAN跨子网模式</h4><ul>
<li>当跨子网时使用<code>ipip/vxlan</code>来进行通讯</li>
<li>将ippool中的<code>IPIPMODE</code>或<code>VXLANMODE</code>修改为<code>CrossSubnet</code>即可</li>
</ul>
<h5 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get no
<span class="token comment"># [root@10-72-164-144 ~]# kubectl get no</span>
<span class="token comment"># NAME            STATUS   ROLES           AGE   VERSION</span>
<span class="token comment"># 10-72-137-177   Ready    control-plane   14d   v1.27.1</span>
<span class="token comment"># 10-72-164-144   Ready    control-plane   14d   v1.27.1</span>
<span class="token comment"># 10-72-164-145   Ready    control-plane   14d   v1.27.1</span>

kubectl get po <span class="token parameter variable">-o</span> wide
<span class="token comment"># [root@10-72-164-144 ~]# kubectl get po -o wide</span>
<span class="token comment"># NAME             READY   STATUS    RESTARTS   AGE   IP              NODE            NOMINATED NODE   READINESS GATES</span>
<span class="token comment"># net-test-5g2hg   1/1     Running   0          14d   10.244.90.196   10-72-164-145   &lt;none>           &lt;none></span>
<span class="token comment"># net-test-5j2kw   1/1     Running   0          14d   10.244.77.194   10-72-164-144   &lt;none>           &lt;none></span>
<span class="token comment"># net-test-dzhhs   1/1     Running   0          14d   10.244.90.132   10-72-137-177   &lt;none>           &lt;none></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>10.72.137.177</code>为一个子网，<code>10.72.164.144,10.72.164.145</code>为同一个子网</li>
</ul>
<h5 id="IPIP"><a href="#IPIP" class="headerlink" title="IPIP"></a>IPIP</h5><ul>
<li>修改ipip为<code>CrossSubnet</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 关闭vxlan如果开启了</span>
calicoctl patch ippool default-ipv4-ippool  <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"vxlanMode": "Never"&#125;&#125;'</span>
calicoctl patch ippool default-ipv4-ippool  <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"ipipMode": "CrossSubnet"&#125;&#125;'</span>

<span class="token comment"># 确认修改</span>
calicoctl get ippool default-ipv4-ippool <span class="token parameter variable">-o</span> wide
<span class="token comment"># [root@10-72-164-144 ~]# calicoctl get ippool default-ipv4-ippool -o wide</span>
<span class="token comment"># NAME                  CIDR            NAT    IPIPMODE      VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="token comment"># default-ipv4-ippool   10.244.0.0/16   true   CrossSubnet   Never       false      false              all()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看路由</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r
<span class="token comment"># [root@10-72-164-144 ~]# ip r</span>
<span class="token comment"># default via 10.72.164.1 dev eth0</span>
<span class="token comment"># 10.72.164.0/24 dev eth0 proto kernel scope link src 10.72.164.144</span>
<span class="token comment"># blackhole 10.244.77.192/26 proto bird</span>
<span class="token comment"># 10.244.77.194 dev cali97faa6acd6c scope link</span>
<span class="token comment"># 10.244.77.195 dev cali8192f92cc2f scope link</span>
<span class="token comment"># 10.244.90.128/26 via 10.72.137.177 dev tunl0 proto bird onlink 跨子网使用了tunlo这个网卡</span>
<span class="token comment"># 10.244.90.192/26 via 10.72.164.145 dev eth0 proto bird</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>确认是ipip网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> addr show  tunl0
<span class="token comment"># [root@10-72-164-144 ~]# ip addr show  tunl0</span>
<span class="token comment"># 9: tunl0@NONE: &lt;NOARP,UP,LOWER_UP> mtu 1480 qdisc noqueue state UNKNOWN qlen 1000</span>
<span class="token comment">#     link/ipip 0.0.0.0 brd 0.0.0.0</span>
<span class="token comment">#     inet 10.244.77.199/32 scope global tunl0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/../images/calico-ipip-2.png" alt="calico-ipip"></p>
<ul>
<li>通过路由可以看到ipip在CrossSubnet下同子网直接通过bgp(bird)获取的路由发送出去,跨子网则使用了ipip隧道</li>
</ul>
<h5 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h5><ul>
<li>修改VXLANMODE为CrossSubnet</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl patch ippool default-ipv4-ippool  <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"ipipMode": "Never"&#125;&#125;'</span>
calicoctl patch ippool default-ipv4-ippool  <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"vxlanMode": "CrossSubnet"&#125;&#125;'</span>

<span class="token comment"># 确认下</span>
calicoctl get ippool default-ipv4-ippool <span class="token parameter variable">-o</span> wide
<span class="token comment"># [root@10-72-164-144 ~]# calicoctl get ippool default-ipv4-ippool -o wide</span>
<span class="token comment"># NAME                  CIDR            NAT    IPIPMODE   VXLANMODE     DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="token comment"># default-ipv4-ippool   10.244.0.0/16   true   Never      CrossSubnet   false      false              all()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看路由</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> r
<span class="token comment"># [root@10-72-164-144 ~]# ip r</span>
<span class="token comment"># default via 10.72.164.1 dev eth0</span>
<span class="token comment"># 10.72.164.0/24 dev eth0 proto kernel scope link src 10.72.164.144</span>
<span class="token comment"># 10.244.0.192/26 via 10.72.164.145 dev eth0 proto 80 onlink</span>
<span class="token comment"># blackhole 10.244.77.192/26 proto 80</span>
<span class="token comment"># 10.244.77.194 dev cali97faa6acd6c scope link</span>
<span class="token comment"># 10.244.77.195 dev cali8192f92cc2f scope link</span>
<span class="token comment"># 10.244.90.128/26 via 10.244.90.135 dev vxlan.calico onlink 跨子网使用了vxlan</span>
<span class="token comment"># 10.244.90.192/26 via 10.72.164.145 dev eth0 proto 80 onlink 同子网其他节点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看vxlan网卡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> addr show vxlan.calico
<span class="token comment"># [root@10-72-164-144 ~]# ip addr show vxlan.calico</span>
<span class="token comment"># 43: vxlan.calico: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN</span>
<span class="token comment">#     link/ether 66:80:c0:e8:b1:d7 brd ff:ff:ff:ff:ff:ff</span>
<span class="token comment">#     inet 10.244.77.200/32 scope global vxlan.calico</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span>
<span class="token comment">#     inet6 fe80::6480:c0ff:fee8:b1d7/64 scope link</span>
<span class="token comment">#        valid_lft forever preferred_lft forever</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/../images/calico-vxlan-2.png" alt="calico-vxlan"></p>
<ul>
<li>结论通过路由可以看到vxlan在CrossSubnet下同子网直接通过eth0发送出去,跨子网则使用了vxlan</li>
</ul>
<h5 id="跨子网bgp-full-mesh模式下路由"><a href="#跨子网bgp-full-mesh模式下路由" class="headerlink" title="跨子网bgp full mesh模式下路由"></a>跨子网bgp full mesh模式下路由</h5><ul>
<li>查看路由</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># [root@10-72-164-144 ~]# calicoctl get ippool default-ipv4-ippool -o wide</span>
<span class="token comment"># NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="token comment"># default-ipv4-ippool   10.244.0.0/16   true   Never      Never       false      false              all()</span>

<span class="token function">ip</span> r
<span class="token comment"># [root@10-72-164-144 ~]# ip r</span>
<span class="token comment"># default via 10.72.164.1 dev eth0</span>
<span class="token comment"># 10.72.164.0/24 dev eth0 proto kernel scope link src 10.72.164.144</span>
<span class="token comment"># blackhole 10.244.77.192/26 proto bird</span>
<span class="token comment"># 10.244.77.194 dev cali97faa6acd6c scope link</span>
<span class="token comment"># 10.244.77.195 dev cali8192f92cc2f scope link</span>
<span class="token comment"># 10.244.90.128/26 via 10.72.164.1 dev eth0 proto bird</span>
<span class="token comment"># 10.244.90.192/26 via 10.72.164.145 dev eth0 proto bird</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>可以看到在跨子网时,路由指向了当前节点的网关，但我们的网关却不知道10.244.90.128&#x2F;26路由到哪里，所以10.244.90.128&#x2F;26的地址不通</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">k get po <span class="token parameter variable">-o</span> wide
<span class="token comment"># [root@10-72-164-144 ~]# k get po -o wide</span>
<span class="token comment"># NAME             READY   STATUS    RESTARTS   AGE   IP              NODE            NOMINATED NODE   READINESS GATES</span>
<span class="token comment"># net-test-5g2hg   1/1     Running   0          14d   10.244.90.196   10-72-164-145   &lt;none>           &lt;none></span>
<span class="token comment"># net-test-5j2kw   1/1     Running   0          14d   10.244.77.194   10-72-164-144   &lt;none>           &lt;none></span>
<span class="token comment"># net-test-dzhhs   1/1     Running   0          14d   10.244.90.132   10-72-137-177   &lt;none>           &lt;none></span>
k <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> net-test-5g2hg -- <span class="token function">ping</span> <span class="token number">10.244</span>.90.132
<span class="token comment"># [root@10-72-164-144 ~]# k exec -it net-test-5g2hg -- ping 10.244.90.132</span>
<span class="token comment"># PING 10.244.90.132 (10.244.90.132): 56 data bytes</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>符合预期</li>
</ul>
<h5 id="将ipip和vxlan全部设置为CrossSubnet"><a href="#将ipip和vxlan全部设置为CrossSubnet" class="headerlink" title="将ipip和vxlan全部设置为CrossSubnet"></a>将ipip和vxlan全部设置为CrossSubnet</h5><ul>
<li>不行</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@10-72-164-144 ~<span class="token punctuation">]</span><span class="token comment"># calicoctl patch ippool default-ipv4-ippool  -p '&#123;"spec":&#123;"vxlanMode": "CrossSubnet"&#125;&#125;'</span>
Successfully patched <span class="token number">1</span> <span class="token string">'IPPool'</span> resource
<span class="token punctuation">[</span>root@10-72-164-144 ~<span class="token punctuation">]</span><span class="token comment"># calicoctl patch ippool default-ipv4-ippool  -p '&#123;"spec":&#123;"ipipMode": "CrossSubnet"&#125;&#125;'</span>
Hit error: updating existing resource: error with field IPPool.Spec.VXLANMode <span class="token operator">=</span> <span class="token string">'CrossSubnet'</span> <span class="token punctuation">(</span>Cannot <span class="token builtin class-name">enable</span> both VXLAN and IPIP on the same IPPool<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="EBPF"><a href="#EBPF" class="headerlink" title="EBPF"></a>EBPF</h4><blockquote>
<p>epbf是一个内核虚拟机</p>
</blockquote>
<h5 id="EBPF部署"><a href="#EBPF部署" class="headerlink" title="EBPF部署"></a>EBPF部署</h5><h6 id="环境验证"><a href="#环境验证" class="headerlink" title="环境验证"></a>环境验证</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uname</span> <span class="token parameter variable">-rv</span>
<span class="token comment"># docker@minikube:~$ uname -rv</span>
<span class="token comment"># 5.15.49-linuxkit #1 SMP PREEMPT Tue Sep 13 07:51:32 UTC 2022</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ebpf对内核版本要求比较高，内核版本最高5.0往上，红帽4.8往上也行</li>
</ul>
<h6 id="修改api-server地址"><a href="#修改api-server地址" class="headerlink" title="修改api-server地址"></a>修改api-server地址</h6><ul>
<li>calico默认使用的是kube-proxy提供的api-server的svc地址需要改为api-server负载均衡的地址</li>
<li>可以通过<code>kubelet</code>的配置文件来查看，</li>
<li>创建配置文件</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>services<span class="token punctuation">-</span>endpoint
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">KUBERNETES_SERVICE_HOST</span><span class="token punctuation">:</span> <span class="token string">"192.168.49.2"</span> <span class="token comment"># &lt;API server host></span>
  <span class="token key atrule">KUBERNETES_SERVICE_PORT</span><span class="token punctuation">:</span> <span class="token string">"8443"</span>         <span class="token comment"># &lt;API server port></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>重启calico组件</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system rollout restart deployment calico-kube-controllers
kubectl <span class="token parameter variable">-n</span> kube-system rollout restart ds calico-node<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h6 id="开启ebpf"><a href="#开启ebpf" class="headerlink" title="开启ebpf"></a>开启ebpf</h6><ul>
<li>配置kube-proxy</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl patch ds <span class="token parameter variable">-n</span> kube-system kube-proxy <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"nodeSelector":&#123;"non-calico": "true"&#125;&#125;&#125;&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>开启ebpf</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl patch felixconfiguration default <span class="token parameter variable">--patch</span><span class="token operator">=</span><span class="token string">'&#123;"spec": &#123;"bpfEnabled": true&#125;&#125;'</span>
<span class="token comment"># Successfully patched 1 'FelixConfiguration' resource</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h6 id="开启dsr"><a href="#开启dsr" class="headerlink" title="开启dsr"></a>开启dsr</h6><blockquote>
<p>dsr可以保留客户端ip</p>
</blockquote>
<ul>
<li><p>主要是修改<code>BPFExternalServiceMode</code>这个变量</p>
</li>
<li><p>开启dsr</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl patch felixconfiguration default <span class="token parameter variable">--patch</span><span class="token operator">=</span><span class="token string">'&#123;"spec": &#123;"bpfExternalServiceMode": "DSR"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>回滚</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">calicoctl patch felixconfiguration default <span class="token parameter variable">--patch</span><span class="token operator">=</span><span class="token string">'&#123;"spec": &#123;"bpfExternalServiceMode": "Tunnel"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="IP地址管理"><a href="#IP地址管理" class="headerlink" title="IP地址管理"></a>IP地址管理</h4><h5 id="静态ip"><a href="#静态ip" class="headerlink" title="静态ip"></a>静态ip</h5><ul>
<li><p>一般来说pod不需要pod的ip是静态的，而是已通过service来访问，但是在安全等领域可能需要pod的ip是静态或者一小段范围</p>
</li>
<li><p>使用ipam里面的ip</p>
</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">'cni.projectcalico.org/ipAddrs'</span><span class="token punctuation">:</span> <span class="token string">'["192.168.0.1"]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h6 id="不使用ipam里面的ip"><a href="#不使用ipam里面的ip" class="headerlink" title="不使用ipam里面的ip"></a>不使用ipam里面的ip</h6><blockquote>
<p>此功能需要cni开启特性才行</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system edit cm calico-config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"any_name"</span><span class="token punctuation">,</span>
  <span class="token property">"cniVersion"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"calico"</span><span class="token punctuation">,</span>
  <span class="token property">"ipam"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"calico-ipam"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"feature_control"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"ip_addrs_no_ipam"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>然后重启calico的agent</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system rollout restart ds calico-node<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>在pod上添加下面的注释</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">'cni.projectcalico.org/ipAddrsNoIpam'</span><span class="token punctuation">:</span> <span class="token string">'["10.0.0.1"]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>此时pod的ip则会设置为<code>10.0.0.1</code>,但是这个ip只能在你在pod所在的node上ping通过，路由等需要自己手动处理</li>
</ul>
<h5 id="Floating-IP-浮动ip"><a href="#Floating-IP-浮动ip" class="headerlink" title="Floating IP(浮动ip)"></a>Floating IP(浮动ip)</h5><blockquote>
<p>Floating IP（浮动IP）是一种IP地址分配技术，它能够将一个IP地址从一台主机转移到另一台主机。 浮动IP通常用于云计算环境中，因为在这种环境下，虚拟资源（如虚拟机）可能随时在不同的物理主机之间移动。</p>
</blockquote>
<div class="note warning"><p>只能在BGP模式下使用</p>
</div>

<ul>
<li>也需要打开特性和上面noipam的类似方法不做赘述</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"any_name"</span><span class="token punctuation">,</span>
  <span class="token property">"cniVersion"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"calico"</span><span class="token punctuation">,</span>
  <span class="token property">"ipam"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"calico-ipam"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"feature_control"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"floating_ips"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">'cni.projectcalico.org/floatingIPs'</span><span class="token punctuation">:</span> <span class="token string">'["10.0.0.1"]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="IP预留"><a href="#IP预留" class="headerlink" title="IP预留"></a>IP预留</h5><ul>
<li>顾名思义保留的ip不会分配给pod</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPReservation
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>ipreservation<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">reservedCIDRs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> 192.168.2.3
    <span class="token punctuation">-</span> 10.0.2.3/32
    <span class="token punctuation">-</span> cafe<span class="token punctuation">:</span>f00d<span class="token punctuation">:</span><span class="token punctuation">:</span>/123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h5><p>pod的注释&gt;pod所在的ns的注释&gt;ippool</p>
<h4 id="带宽限制"><a href="#带宽限制" class="headerlink" title="带宽限制"></a>带宽限制</h4><ul>
<li>cni配置文件需要设置如下参数</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"bandwidth"</span><span class="token punctuation">,</span>
  <span class="token property">"capabilities"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"bandwidth"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>在pod上配置带宽</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/ingress-bandwidth</span><span class="token punctuation">:</span> 1M <span class="token comment"># 进入</span>
    <span class="token key atrule">kubernetes.io/egress-bandwidth</span><span class="token punctuation">:</span> 1M  <span class="token comment"># 出口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>实际是调用了<code>bandwidth</code>这个cni插件</li>
</ul>
<h4 id="指定MAC地址"><a href="#指定MAC地址" class="headerlink" title="指定MAC地址"></a>指定MAC地址</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">"cni.projectcalico.org/hwAddr"</span><span class="token punctuation">:</span> <span class="token string">"1c:0c:0a:c0:ff:ee"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>重启pod生效</li>
</ul>
<h4 id="开启ipv6支持"><a href="#开启ipv6支持" class="headerlink" title="开启ipv6支持"></a>开启ipv6支持</h4><blockquote>
<p>ipv6需要k8s同步开启双栈</p>
</blockquote>
<h5 id="修改cni配置文件"><a href="#修改cni配置文件" class="headerlink" title="修改cni配置文件"></a>修改cni配置文件</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token parameter variable">-n</span> kube-system edit cm calico-config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"ipam"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"calico-ipam"</span><span class="token punctuation">,</span>
    <span class="token property">"assign_ipv4"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
    <span class="token property">"assign_ipv6"</span><span class="token operator">:</span> <span class="token string">"true"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="修改DS环境变量"><a href="#修改DS环境变量" class="headerlink" title="修改DS环境变量"></a>修改DS环境变量</h5><table>
<thead>
<tr>
<th>环境变量</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>IP6</td>
<td>autodetect</td>
</tr>
<tr>
<td>FELIX_IPV6SUPPORT</td>
<td>true</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改环境变量</span>
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">IP6</span><span class="token operator">=</span>autodetect
kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">set</span> <span class="token function">env</span> ds/calico-node <span class="token parameter variable">-c</span> calico-node <span class="token assign-left variable">FELIX_IPV6SUPPORT</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/about">https://docs.tigera.io/calico/latest/about</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cni/" rel="tag"># cni</a>
              <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/11/gomod%E4%BD%BF%E7%94%A8%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/" rel="prev" title="gomod使用私有仓库">
                  <i class="fa fa-angle-left"></i> gomod使用私有仓库
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/25/%E4%BD%BF%E7%94%A8kubespray%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/" rel="next" title="使用kubespray部署k8s集群">
                  使用kubespray部署k8s集群 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Nature丿灵然</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.min.js","integrity":"sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body>
</html>
